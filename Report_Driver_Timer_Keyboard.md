# 单片机与嵌入式系统实验报告 - 驱动程序设计部分

**分工模块**：驱动：定时、键盘
**小组成员**：tr

## 1. 模块概述

本部分主要负责底层硬件驱动的编写，旨在为上层任务调度和应用逻辑提供稳定的硬件抽象接口。具体涵盖了 C8051F020 单片机的定时器（Timer0、Timer1）配置以及 4x4 矩阵键盘的底层扫描驱动。

代码主要位于工程目录的 `bsp/` 文件夹下，属于板级支持包（Board Support Package）的一部分。

## 2. 定时器驱动设计

本系统使用了两个定时器：Timer0 作为系统的主要心跳（Tick），用于任务调度和计时功能；Timer1 用于数码管的动态扫描刷新。

### 2.1 Timer0 驱动设计 (`bsp/timer0.asm`)

Timer0 被配置为系统时基发生器，提供 10ms 的定时中断。

*   **初始化配置 (`Timer0_Init`)**：
    *   设置定时器初值。根据代码 `MOV TH0, #0D8h`, `MOV TL0, #0F0h`，计数器初值为 `0xD8F0`。
    *   在 12MHz 晶振（或系统时钟配置）下，溢出周期约为 10ms。
    *   开启定时器中断 `ET0` 和全局中断 `EA`。

*   **中断服务服务程序 (`TIMER0_ISR`)**：
    *   **重装载初值**：手动重装载 `TH0` 和 `TL0` 以保持 10ms 周期。
    *   **核心功能**：
        1.  **按键长按检测**：配合键盘模块，通过寄存器 `047h` 进行计数，实现按键的长按判断逻辑。
        2.  **系统时间维护**：通过 `ONE_SEC_CNT` (`059h`) 计数实现秒级计时。
        3.  **电梯运行控制**：在 ISR 中处理电梯状态机的部分时序逻辑，例如电梯移动过程中的楼层更新检测和开关门延时递减 (`057h`)。

### 2.2 Timer1 驱动设计 (`bsp/timer1.asm`)

Timer1 专门用于驱动 6 位数码管的动态显示，利用人眼的视觉暂留效应实现多位显示。

*   **初始化配置 (`Timer1_Init`)**：
    *   配置 TMOD 寄存器为 `#011h`，设置 Timer1 为 16 位定时器模式。
    *   初值设置为 `TH1 = #0FCh`, `TL1 = #018h`，产生较高频率的中断以保证扫描不闪烁。
    *   开启 Timer1 中断。

*   **中断服务程序 (`TIMER1_ISR`)**：
    *   保护现场（Push PSW, ACC 等）。
    *   重装载初值。
    *   调用外部驱动函数 `LED6_Refresh`（位于 `driver/LED6.asm`），完成当前位选和段码的输出刷新。
    *   恢复现场并返回。

## 3. 键盘驱动设计 (`bsp/Keyboard.asm`)

系统采用 4x4 矩阵键盘作为人机交互输入设备。本驱动层主要负责底层的电平扫描，将物理按键映射为键值。

*   **硬件连接**：
    *   键盘采用行列式连接，通常连接在 P1 口。
    *   高 4 位（P1.7-P1.4）作为输入检测（行或列）。
    *   低 4 位（P1.3-P1.0）作为扫描输出（列或行）。

*   **扫描算法 (`MatrixKey`)**：
    *   **原理**：采用主要采用“逐列扫描法”（或逐行）。
    *   **实现流程**：
        1.  初始状态将 P1 口置高。
        2.  **第一轮扫描**：拉低 P1.3，检测 P1.7-P1.4 的状态。如果发现低电平，说明对应行有按键按下，根据位置返回对应键值（如 `0Fh`, `0Eh`, `0Dh`, `0Ch`）。
        3.  **后序扫描**：依次拉低 P1.2, P1.1, P1.0，重复上述检测步骤。
    *   **返回值**：
        *   累加器 `A`：返回检测到的键值（1-16）。
        *   若无按键按下，返回 `0FFh`。
        *   辅助调试信息：寄存器 `040h` 存储行号，`041h` 存储列号，方便后续状态机调用或调试。

## 4. 总结与心得

作为驱动层的负责人，主要的挑战在于确保硬件操作的原子性和时序的准确性。
1.  **关于定时器**：Timer0 的 ISR 不仅仅是计数，还承担了一部分“下半部”处理的工作（如电梯状态判断），这虽然增加了 ISR 的长度，但简化了主循环的逻辑。在编写汇编中断时，现场保护（PUSH/POP）尤为重要，必须严格配对否则会导致堆栈溢出程序跑飞。
2.  **关于键盘**：底层的 `MatrixKey` 只负责“瞬时”的扫描，消抖和长按判断逻辑交由上层（Timer0 和 KeyInput）处理，体现了分层设计的思想。

通过本次实验，加深了对 C8051F020 特殊功能寄存器（SFR）配置的理解，以及汇编语言下硬件驱动编写的规范。
