ORG 0000h
	LJMP MAIN

ORG 000Bh
	LJMP TIMER0_ISR

ORG 001Bh
	LJMP TIMER1_ISR

$INCLUDE (config.inc)

; P2.0-P2.5 控制 6 位数码管
; 假设 P2.0 为最左侧 (Digit 5, Buffer 0x35)
; 假设 P2.5 为最右侧 (Digit 0, Buffer 0x30)
; 扫描顺序 Buffer 0x30 -> 0x35
BITMASK_TABLE:
	DB 020h,010h,008h,004h,002h,001h
    ; Buffer Index: 0(30h) -> P2.5, ..., 5(35h) -> P2.0

PASSWORD_TABLE:
	DB 01h,02h,03h,04h,05h
	; 默认密码 12345

; 状态常量定义
RUN_ST	EQU	00h
OPT_ST	EQU	01h
PASS_ST	EQU	02h
OPT1_ST	EQU	11h
OPT2_ST	EQU	12h
OPT3_ST	EQU	13h

; 变量分配同前
; 0x30~0x35: 显示缓存 (6 Bytes)

MatrixKey:
				MOV A,#0FFh    ; 默认返回 0xFF 表示无键按下
				MOV P1,#0FFh

				CLR P1.3
				JB P1.7,MK_SK1
				AJMP MXK_1_CHECK
MK_SK1:
				JB P1.6,MK_SK2
				AJMP MXK_5_CHECK
MK_SK2:
				JB P1.5,MK_SK3
				AJMP MXK_9_CHECK
MK_SK3:
				JB P1.4,MK_SK4
				AJMP MXK_13_CHECK
MK_SK4:
				MOV P1,#0FFh

				CLR P1.2
				JB P1.7,MK_SK5
				AJMP MXK_2_CHECK
MK_SK5:
				JB P1.6,MK_SK6
				AJMP MXK_6_CHECK
MK_SK6:
				JB P1.5,MK_SK7
				AJMP MXK_10_CHECK
MK_SK7:
				JB P1.4,MK_SK8
				AJMP MXK_14_CHECK
MK_SK8:
				MOV P1,#0FFh

				CLR P1.1
				JB P1.7,MK_SK9
				AJMP MXK_3_CHECK
MK_SK9:
				JB P1.6,MK_SK10
				AJMP MXK_7_CHECK
MK_SK10:
				JB P1.5,MK_SK11
				AJMP MXK_11_CHECK
MK_SK11:
				JB P1.4,MK_SK12
				AJMP MXK_15_CHECK
MK_SK12:
				MOV P1,#0FFh

				CLR P1.0
				JB P1.7,MK_SK13
				AJMP MXK_4_CHECK
MK_SK13:
				JB P1.6,MK_SK14
				AJMP MXK_8_CHECK
MK_SK14:
				JB P1.5,MK_SK15
				AJMP MXK_12_CHECK
MK_SK15:
				JB P1.4,MK_SK16
				AJMP MXK_16_CHECK
MK_SK16:
				MOV P1,#0FFh
				RET

MXK_1_CHECK:
				MOV A,#0Fh
				MOV 040h,#01
				MOV 041h,#01
				RET
MXK_5_CHECK:
				MOV A,#0Eh
				MOV 040h,#01
				MOV 041h,#02
				RET
MXK_9_CHECK:
				MOV A,#0Dh
				MOV 040h,#01
				MOV 041h,#03
				RET
MXK_13_CHECK:
				MOV A,#0Ch
				MOV 040h,#01
				MOV 041h,#04
				RET
MXK_2_CHECK:
				MOV A,#0Bh
				MOV 040h,#02
				MOV 041h,#01
				RET
MXK_6_CHECK:
				MOV A,#0Ah
				MOV 040h,#02
				MOV 041h,#02
				RET
MXK_10_CHECK:
				MOV A,#09
				MOV 040h,#02
				MOV 041h,#03
				RET
MXK_14_CHECK:
				MOV A,#08
				MOV 040h,#02
				MOV 041h,#04
				RET
MXK_3_CHECK:
				MOV A,#07
				MOV 040h,#03
				MOV 041h,#01
				RET
MXK_7_CHECK:
				MOV A,#06
				MOV 040h,#03
				MOV 041h,#02
				RET
MXK_11_CHECK:
				MOV A,#05
				MOV 040h,#03
				MOV 041h,#03
				RET
MXK_15_CHECK:
				MOV A,#04
				MOV 040h,#03
				MOV 041h,#04
				RET
MXK_4_CHECK:
				MOV A,#03
				MOV 040h,#04
				MOV 041h,#01
				RET
MXK_8_CHECK:
				MOV A,#02
				MOV 040h,#04
				MOV 041h,#02
				RET
MXK_12_CHECK:
				MOV A,#01
				MOV 040h,#04
				MOV 041h,#03
				RET
MXK_16_CHECK:
				MOV A,#00
				MOV 040h,#04
				MOV 041h,#04
				RET

	ORG 0700h
MAIN:
	MOV P0, #0FFh
	MOV P2, #00h
	
	; 初始化显示缓冲 (6位)
	MOV 030h, #010h
	MOV 031h, #010h
	MOV 032h, #010h
	MOV 033h, #010h
	MOV 034h, #010h
	MOV 035h, #010h
	
	MOV 038h, #00h

	MOV 070h, #00h
	MOV 071h, #00h

	MOV 044h, #0FFh
	MOV 045h, #00h
	MOV 046h, #0FFh
	MOV 047h, #00h
	MOV 048h, #00h
	MOV 03Ah, #03h
	
	
	MOV TMOD, #011h
	MOV TH1, #0FCh
	MOV TL1, #018h
	MOV TH0, #0D8h
	MOV TL0, #0F0h
	MOV IE,  #08Ah
	SETB TR1      
	SETB TR0      

LOOP:
	LCALL MatrixKey 
	CJNE A,044h,MXK_SAMPLE_CHANGED
	INC 045h
	SJMP MXK_AFTER_STABLE_CHECK

MXK_SAMPLE_CHANGED:
	MOV 044h, A
	MOV 045h, #01

MXK_AFTER_STABLE_CHECK:
	MOV A, 045h
	CJNE A,#03,MXK_STATE_CHECK
	SJMP MXK_CHECK_CONF

MXK_CHECK_CONF:
	MOV A, 046h
	CJNE A,044h,MXK_CONF_CHANGED
	SJMP MXK_STATE_CHECK

MXK_CONF_CHANGED:
	MOV A, 044h
	MOV 046h, A
	MOV A, 048h
	CJNE A, #02h, MXK_CONF_CHECK_RELEASE
	MOV 047h, #00h
	MOV 048h, #00h
	SJMP MXK_STATE_CHECK

MXK_CONF_CHECK_RELEASE:
	MOV A, 044h
	CJNE A,#0FFh,MXK_CONF_PRESSED
	MOV A, 047h
	CLR C
	SUBB A, #064h
	JNC MXK_LONG_PRESS
	SJMP MXK_SHORT_PRESS

MXK_LONG_PRESS:
	MOV 047h, #00h
	MOV 048h, #00h
	SJMP MXK_STATE_CHECK

MXK_SHORT_PRESS:
	MOV 047h, #00h
	MOV 048h, #00h
	SJMP MXK_STATE_CHECK

MXK_CONF_PRESSED:
	MOV A, 044h
	ANL A, #0Fh
	MOV 060h, A
	MOV 061h, #01h
	MOV 047h, #00h
	MOV 048h, #00h

MXK_STATE_CHECK:
	MOV A, 070h
	CJNE A,#RUN_ST, CHECK_OPT
	LCALL RUN_HANDLER
	SJMP LOOP
CHECK_OPT:
	CJNE A,#OPT_ST, CHECK_OPT1
	LCALL OPT_HANDLER
	AJMP LOOP
CHECK_OPT1:
	CJNE A,#OPT1_ST, CHECK_OPT2
	LCALL OPT1_HANDLER
	AJMP LOOP
CHECK_OPT2:
	CJNE A,#OPT2_ST, CHECK_OPT3
	LCALL OPT2_HANDLER
	AJMP LOOP
CHECK_OPT3:
	CJNE A,#OPT3_ST, CHECK_PASS
	LCALL OPT3_HANDLER
	AJMP LOOP
CHECK_PASS:
	CJNE A,#PASS_ST, SKIP_PASS
	LCALL PASS_HANDLER
	AJMP LOOP
SKIP_PASS:
	AJMP LOOP

TIMER1_ISR:
	PUSH PSW
	PUSH ACC
	PUSH B
	PUSH DPL
	PUSH DPH
	PUSH 00h
	PUSH 01h

	MOV TH1, #0FCh
	MOV TL1, #018h

	MOV P0, #0FFh
	MOV P2, #00h

	; 0..5 循环
	MOV A, 038h
	MOV R2, A         ; R2 = index
	ADD A, #030h
	MOV R0, A
	MOV A, @R0        ; 读 Buffer
	MOV B, A

	MOV DPTR, #SEG_TABLE
	MOV A, B
	MOVC A, @A+DPTR   
	MOV B, A          

	MOV DPTR, #BITMASK_TABLE
	MOV A, R2         
	MOVC A, @A+DPTR
	MOV R1, A

	MOV A, B
	MOV P0, A
	MOV A, R1
	MOV P2, A

	INC 038h
	MOV A, 038h
	CJNE A, #06, ISR_EXIT ; 6 位数码管
	MOV 038h, #00h

ISR_EXIT:
	POP 01h
	POP 00h
	POP DPH
	POP DPL
	POP B
	POP ACC
	POP PSW
	RETI

TIMER0_ISR:
	PUSH PSW
	PUSH ACC
	PUSH B

	MOV TH0, #0D8h
	MOV TL0, #0F0h

	MOV A, 046h
	CJNE A, #0FFh, T0_KEY_HELD
	SJMP T0_EXIT

T0_KEY_HELD:
	MOV A, 047h
	CJNE A, #0FFh, T0_INC
	SJMP T0_EXIT
T0_INC:
	INC 047h
	MOV A, 047h
	CLR C
	SUBB A, #064h
	JNC T0_LONG_REACHED
	SJMP T0_EXIT

T0_LONG_REACHED:
	MOV A, 048h
	CJNE A, #00h, T0_EXIT
	MOV A, 060h
	ANL A, #0Fh
	ORL A, #080h
	MOV 060h, A
	MOV 061h, #01h
	MOV 048h, #02h
	MOV 047h, #064h
	SJMP T0_EXIT

T0_EXIT:
	POP B
	POP ACC
	POP PSW
	RETI

;-----------------------------
; 状态机
;-----------------------------

RUN_HANDLER:
		MOV A, 071h
		CJNE A, 070h, RUN_INIT    

		MOV A, 061h
		CJNE A, #00h, RUN_HANDLE_KEY
		SJMP RUN_MODE

RUN_HANDLE_KEY:
		MOV A, 060h
		CJNE A, #08Ah, RUN_HANDLE_OTHER
		MOV 070h, #PASS_ST
		MOV 061h, #00h
		SJMP RUN_MODE

RUN_HANDLE_OTHER:
		MOV 061h, #00h
		SJMP RUN_MODE

RUN_INIT:
		MOV A, 070h
		MOV 071h, A
		SJMP RUN_MODE

RUN_MODE:
		MOV 030h, #010h
		MOV 031h, #010h
		MOV 032h, #010h
		MOV 033h, #010h
		MOV 034h, #010h
		MOV 035h, #010h
		MOV 039h, #04h ; 密码光标初始化位置 (for later use)
		RET

OPT_HANDLER:
        MOV A, 071h
        CJNE A, 070h, OPT_INIT
        MOV A, 061h
        CJNE A, #00h, OPT_HANDLE_KEY
        AJMP OPT_MODE

OPT_INIT:
        MOV A, 070h
        MOV 071h, A
        SJMP OPT_MODE

OPT_MODE:
        ; 显示菜单 (6位): 1.n 2.r 3.C
        ; 35: 1. (0x15)
        ; 34: n  (0x1E)
        ; 33: 2. (0x16)
        ; 32: r  (0x12)
        ; 31: 3. (0x17)
        ; 30: C  (0x0C)
        MOV 035h, #015h  
        MOV 034h, #01Eh
        MOV 033h, #016h
        MOV 032h, #012h
        MOV 031h, #017h
        MOV 030h, #00Ch
        RET

OPT_HANDLE_KEY:
		MOV A, 060h
		ANL A, #0Fh
		CJNE A, #0Ah, OPT_CHECK_KEY1
		LCALL OPT_CHECK_ALL_INPUTS
		RET

OPT_CHECK_KEY1:
		MOV A, 060h
		ANL A, #0Fh
		CJNE A, #01h, OPT_CHECK_KEY2
		MOV 070h, #OPT1_ST
		MOV 061h, #00h
		RET

OPT_CHECK_KEY2:
		MOV A, 060h
		ANL A, #0Fh
		CJNE A, #02h, OPT_CHECK_KEY3
		MOV 070h, #OPT2_ST
		MOV 061h, #00h
		RET

OPT_CHECK_KEY3:
		MOV A, 060h
		ANL A, #0Fh
		CJNE A, #03h, OPT_HANDLE_KEY_SKIP
		MOV 070h, #OPT3_ST
		MOV 061h, #00h
		RET

OPT_HANDLE_KEY_SKIP:
		MOV 061h, #00h
		RET

OPT_CHECK_ALL_INPUTS:
		MOV A, 050h
		JZ OPT_INPUT_INCOMPLETE
		MOV A, 052h
		JZ OPT_INPUT_INCOMPLETE
		MOV A, 054h
		JZ OPT_INPUT_INCOMPLETE
		
		MOV 070h, #RUN_ST
		MOV 061h, #00h
		RET

OPT_INPUT_INCOMPLETE:
		; 显示 Err011 (6位)
		MOV 035h, #00Eh    ; E
		MOV 034h, #012h   ; r
		MOV 033h, #012h   ; r
		MOV 032h, #00h    ; 0
		MOV 031h, #01h    ; 1
		MOV 030h, #01h    ; 1
		
		MOV R3, #04h
OPT_ERROR_DELAY_OUTER:
		MOV R4, #0F0h
OPT_ERROR_DELAY_LOOP:
		MOV R5, #0FFh
OPT_ERROR_DELAY_INNER:
		NOP
		NOP
		NOP
		DJNZ R5, OPT_ERROR_DELAY_INNER
		DJNZ R4, OPT_ERROR_DELAY_LOOP
		DJNZ R3, OPT_ERROR_DELAY_OUTER
		
		MOV 061h, #00h
		RET



OPT1_HANDLER:
		MOV A, 071h
		CJNE A, 070h, OPT1_INIT
		MOV A, 061h
		CJNE A, #00h, OPT1_INPUT_HANDLE_KEY
		SJMP OPT1_INPUT_MODE

OPT1_INPUT_MODE:
		RET

OPT1_INPUT_HANDLE_KEY:
		MOV A, 060h
		ANL A, #0Fh
		MOV R7, A
		CLR C
		SUBB A, #0Ah
		JNC OPT1_INPUT_SPECIAL_KEY

		; 数字键
		MOV A, 03Bh
        ADD A, #030h
        MOV R0, A
		MOV A, R7
        MOV @R0, A

		; 限制输入两位 (33->32)
		MOV A, 03Bh
		CJNE A, #02h, OPT1_INPUT_DEC ; 最低位为 32, 0x02
		SJMP OPT1_INPUT_DONE

OPT1_INPUT_DEC:
        DEC 03Bh

OPT1_INPUT_DONE:
		MOV 061h, #00h
		RET

OPT1_INPUT_SPECIAL_KEY:
		MOV A, 060h
		CJNE A, #0Bh, OPT1_INPUT_CHECK_CONFIRM
		; B键回退
		
		MOV A, 03Bh
		ADD A, #030h
		MOV R0, A
		MOV @R0, #010h
 		INC 03Bh
		; 限制不超过 3 (0x03)
		MOV A, 03Bh
		CLR C
		SUBB A, #04h
		JNC OPT1_INPUT_BACKSPACE_LIMIT
		MOV 061h, #00h
		RET

OPT1_INPUT_BACKSPACE_LIMIT:
		MOV 03Bh, #03h
		MOV A, 03Bh
		ADD A, #030h
		MOV R0, A
		MOV @R0, #010h
		MOV 061h, #00h
		RET

OPT1_INPUT_CHECK_CONFIRM:
		MOV A, 060h
		CJNE A, #0Ah, OPT1_INPUT_SKIP_CONFIRM
		; 确认: 取Buffer 33, 32
		MOV A, 033h
		MOV 050h, A
		MOV A, 032h
		MOV 051h, A
		MOV 061h, #00h
		MOV 070h, #OPT_ST
		RET

OPT1_INPUT_SKIP_CONFIRM:
		MOV 061h, #00h
		RET

OPT1_INIT:
		MOV A, 070h
		MOV 071h, A
		; 显示 "no._d_d__" (适应6位)
		; 35: n (0x1E)
		; 34: o.(0x20)
		; 33: _ (input 1)
		; 32: _ (input 2)
		; 31: _
		; 30: _
		MOV 035h, #01Eh
		MOV 034h, #020h
		MOV 033h, #010h
		MOV 032h, #010h
		MOV 031h, #021h
		MOV 030h, #021h
		MOV 03Bh, #03h    ; 光标从 33h 开始 (Buffer Index 3)
		RET


OPT2_HANDLER:
		MOV A, 071h
		CJNE A, 070h, OPT2_INIT
		MOV A, 061h
		CJNE A, #00h, OPT2_INPUT_HANDLE_KEY
		SJMP OPT2_INPUT_MODE

OPT2_INPUT_MODE:
		RET

OPT2_INPUT_HANDLE_KEY:
		MOV A, 060h
		ANL A, #0Fh
		MOV R7, A
		CLR C
		SUBB A, #0Ah
		JNC OPT2_INPUT_SPECIAL_KEY

		MOV A, 03Bh
        ADD A, #030h
        MOV R0, A
		MOV A, R7
        MOV @R0, A

		MOV A, 03Bh
		CJNE A, #01h, OPT2_INPUT_DEC
		SJMP OPT2_INPUT_DONE

OPT2_INPUT_DEC:
        DEC 03Bh

OPT2_INPUT_DONE:
		MOV 061h, #00h
		RET

OPT2_INPUT_SPECIAL_KEY:
		MOV A, 060h
		CJNE A, #0Bh, OPT2_INPUT_CHECK_CONFIRM
		
		MOV A, 03Bh
		ADD A, #030h
		MOV R0, A
		MOV @R0, #010h
 		INC 03Bh
		MOV A, 03Bh
		CLR C
		SUBB A, #04h
		JNC OPT2_INPUT_BACKSPACE_LIMIT
		MOV 061h, #00h
		RET

OPT2_INPUT_BACKSPACE_LIMIT:
		MOV 03Bh, #03h
		MOV A, 03Bh
		ADD A, #030h
		MOV R0, A
		MOV @R0, #010h
		MOV 061h, #00h
		RET

OPT2_INPUT_CHECK_CONFIRM:
		MOV A, 060h
		CJNE A, #0Ah, OPT2_INPUT_SKIP_CONFIRM
		
		MOV A, 033h
		MOV 052h, A
		MOV A, 032h
		MOV 053h, A
		MOV 061h, #00h
		MOV 070h, #OPT_ST
		RET

OPT2_INPUT_SKIP_CONFIRM:
		MOV 061h, #00h
		RET

OPT2_INIT:
		MOV A, 070h
		MOV 071h, A
		; 显示 "rL_d_d__"
		; 35: r (0x12)
		; 34: L (0x13)
		; 33: _
		; 32: _
		; 31: _
		; 30: _
		MOV 035h, #012h
		MOV 034h, #013h
		MOV 033h, #010h
		MOV 032h, #010h
		MOV 031h, #010h
		MOV 030h, #021h
		MOV 03Bh, #03h    ; 光标从 33h 开始
		RET


OPT3_HANDLER:
		MOV A, 071h
		CJNE A, 070h, OPT3_INIT
		MOV A, 061h
		CJNE A, #00h, OPT3_INPUT_HANDLE_KEY
		SJMP OPT3_INPUT_MODE

OPT3_INPUT_MODE:
		RET

OPT3_INPUT_HANDLE_KEY:
		MOV A, 060h
		ANL A, #0Fh
		MOV R7, A
		CLR C
		SUBB A, #0Ah
		JNC OPT3_INPUT_SPECIAL_KEY

		MOV A, 03Bh
        ADD A, #030h
        MOV R0, A
		MOV A, R7
        MOV @R0, A

		MOV A, 03Bh
		CJNE A, #04h, OPT3_INPUT_DEC ; 最低位 34 (0x04)
		SJMP OPT3_INPUT_DONE

OPT3_INPUT_DEC:
        DEC 03Bh

OPT3_INPUT_DONE:
		MOV 061h, #00h
		RET

OPT3_INPUT_SPECIAL_KEY:
		MOV A, 060h
		CJNE A, #0Bh, OPT3_INPUT_CHECK_CONFIRM
		
		MOV A, 03Bh
		ADD A, #030h
		MOV R0, A
		MOV @R0, #010h
 		INC 03Bh
		MOV A, 03Bh
		CLR C
		SUBB A, #05h
		JNC OPT3_INPUT_BACKSPACE_LIMIT
		MOV 061h, #00h
		RET

OPT3_INPUT_BACKSPACE_LIMIT:
		MOV 03Bh, #04h
		MOV A, 03Bh
		ADD A, #030h
		MOV R0, A
		MOV @R0, #010h
		MOV 061h, #00h
		RET

OPT3_INPUT_CHECK_CONFIRM:
		MOV A, 060h
		CJNE A, #0Ah, OPT3_INPUT_SKIP_CONFIRM
		
		MOV A, 034h
		MOV 054h, A
		MOV 061h, #00h
		MOV 070h, #OPT_ST
		RET

OPT3_INPUT_SKIP_CONFIRM:
		MOV 061h, #00h
		RET

OPT3_INIT:
		MOV A, 070h
		MOV 071h, A
		; 显示 "C._d____"
		; 35: C. (0x22 -> SEG_TABLE[0x16] if remapped? No, user defined code)
		; SEG_TABLE 增加定义 0x46 (index 23) 为 'C.'
		; 35: C.
		; 34: _
		MOV 035h, #017h   ; 0x17 index is C. (Wait: index 17 in table is 0x0C 'P.'?? No)
		; Let's check SEG_TABLE:
		; 0..9 (0-9)
		; A (10), b (11), C (12), d (13), E (14), F (15), _ (16), P. (17), r (18), L (19)
		; 0. (20), 1. (21) ... 9. (29)
		; n (30), o (31), o. (32), OFF (33), C. (34)
		
		MOV 035h, #022h   ; Index 34 ('C.')
		MOV 034h, #010h   ; _
		MOV 033h, #021h
		MOV 032h, #021h
		MOV 031h, #021h
		MOV 030h, #021h
		MOV 03Bh, #04h    ; 光标从 34h 开始
		RET


PASS_HANDLER:
		MOV A, 071h
		CJNE A, 070h, PASS_INIT
		MOV A, 061h
		CJNE A, #00h, PASS_HANDLE_KEY
		SJMP PASS_MODE

PASS_HANDLE_KEY:
		MOV A, 060h
		ANL A, #0Fh
		MOV R7, A
		CLR C
		SUBB A, #0Ah
		JNC PASS_SKIP_UPDATE

		; 数字键
		MOV A, 039h
        ADD A, #030h
        MOV R0, A
		MOV A, R7
        MOV @R0, A

		MOV A, 039h
		CJNE A, #0FFh, PASS_KEY_DEC
		SJMP PASS_KEY_DONE

PASS_KEY_DEC:
        DEC 039H

PASS_KEY_DONE:
		MOV 061h, #00h
		SJMP PASS_MODE

PASS_SKIP_UPDATE:
		MOV A, 060h
		CJNE A, #0Bh, PASS_MODE
		; B键回退
		INC 039h
		MOV A, 039h
		CLR C
		SUBB A, #05h
		JNC PASS_BACKSPACE_LIMIT ; 恢复为 4
		MOV A, 039h
		ADD A, #030h
		MOV R0, A
		MOV @R0, #010h
		MOV 061h, #00h
		SJMP PASS_MODE

PASS_BACKSPACE_LIMIT:
		MOV 039h, #04h
		MOV A, 039h
		ADD A, #030h
		MOV R0, A
		MOV @R0, #010h
		MOV 061h, #00h
		SJMP PASS_MODE

PASS_INIT:
		MOV A, 070h
		MOV 071h, A      
		MOV 070h, #PASS_ST
		
		; 显示 "P._____" (6位)
		; 35: P. (0x11)
		; 34~30: _
		MOV 035h, #011h
		MOV 034h, #010h
		MOV 033h, #010h
		MOV 032h, #010h
		MOV 031h, #010h
		MOV 030h, #010h
		
		MOV 039h, #04h     ; 光标位置 4 (Buffer 34h)
		RET

PASS_MODE:
		MOV A, 061h
		CJNE A, #00h, PASS_MODE_CHECK_KEY
		RET

PASS_MODE_CHECK_KEY:
		MOV A, 060h
		CJNE A, #0Ah, PASS_MODE_SKIP_CONFIRM
		
		MOV A, 039h
		CJNE A, #0FFh, PASS_CONFIRM_INCOMPLETE
		LCALL PASS_VERIFY_PASSWORD
		MOV 061h, #00h
		RET

PASS_CONFIRM_INCOMPLETE:
		LCALL PASS_SHOW_ERROR
		MOV 061h, #00h
		RET

PASS_MODE_SKIP_CONFIRM:
		MOV 061h, #00h
		RET

PASS_VERIFY_PASSWORD:
		; 验证 5 位密码 (Buffer 34..30) vs Table 0..4
		MOV R0, #04h    ; Buffer Index
		MOV R3, #00h    ; Table Index

PASS_VERIFY_LOOP:
		MOV A, R0
		ADD A, #030h
		MOV R1, A
		MOV A, @R1      
		MOV R2, A       
		
		MOV DPTR, #PASSWORD_TABLE
		MOV A, R3
		MOVC A, @A+DPTR 
		
		CJNE A, 02h, PASS_VERIFY_FAIL_CHECK
		SJMP PASS_VERIFY_NEXT

PASS_VERIFY_FAIL_CHECK:
		MOV A, R2
		MOV B, A
		MOV A, R3
		MOV DPTR, #PASSWORD_TABLE
		MOVC A, @A+DPTR
		CJNE A, B, PASS_VERIFY_FAIL

PASS_VERIFY_NEXT:
		DEC R0
		INC R3
		MOV A, R3
		CJNE A, #05h, PASS_VERIFY_LOOP ; 5位
		LCALL PASS_SHOW_SUCCESS
		RET

PASS_VERIFY_FAIL:
		LCALL PASS_SHOW_ERROR
		RET

PASS_SHOW_ERROR:
		DEC 03Ah
		MOV A, 03Ah
		JZ PASS_ERROR_LOCKED
		
		; 显示 FALSEX (6位)
		; 35: F (0x0F)
		; 34: A (0x0A)
		; 33: L (0x13)
		; 32: S (0x05)
		; 31: E (0x0E)
		; 30: Count
		MOV 035h, #00Fh
		MOV 034h, #00Ah
		MOV 033h, #013h
		MOV 032h, #005h
		MOV 031h, #00Eh
		MOV A, 03Ah
		MOV 030h, A
		
		MOV R3, #06h
PASS_ERROR_DELAY_OUTER:
		MOV R4, #0F0h
PASS_ERROR_DELAY_LOOP:
		MOV R5, #0FFh
PASS_ERROR_DELAY_INNER:
		NOP
		NOP
		NOP
		DJNZ R5, PASS_ERROR_DELAY_INNER
		DJNZ R4, PASS_ERROR_DELAY_LOOP
		DJNZ R3, PASS_ERROR_DELAY_OUTER
		
		AJMP PASS_INIT

PASS_ERROR_LOCKED:
		; Err011
		MOV 030h, #01h 
		MOV 031h, #01h 
		MOV 032h, #00h 
		MOV 033h, #012h
		MOV 034h, #012h
		MOV 035h, #00Eh
		AJMP PASS_ERROR_LOCKED

PASS_SHOW_SUCCESS:
		MOV 070h, #OPT_ST
		RET

END
