
ORG 0000h
	LJMP MAIN

ORG 000Bh
	LJMP TIMER0_ISR

ORG 001Bh
	LJMP TIMER1_ISR

$INCLUDE (config.inc)


; 变量分配同前
; 0x30~0x35: 显示缓存 (6 Bytes)

EXTRN	CODE(MatrixKey)
EXTRN	CODE(LED6_Clear)
EXTRN	CODE(LED6_Show_MENU)
EXTRN	CODE(LED6_Show_NO_INPUT)
EXTRN	CODE(LED6_Show_ERR011)
EXTRN	CODE(LED6_Show_PASS_INIT)
EXTRN	CODE(LED6_Show_OPT2_INIT)
EXTRN	CODE(LED6_Show_OPT3_INIT)
EXTRN	CODE(LED6_Show_FALSEX)
EXTRN	CODE(RUN_HANDLER)
EXTRN	CODE(OPT_HANDLER)
EXTRN	CODE(OPT1_HANDLER)
EXTRN	CODE(OPT2_HANDLER)
EXTRN	CODE(OPT3_HANDLER)
ORG 0700h
EXTRN	CODE(TIMER0_ISR)
EXTRN	CODE(TIMER1_ISR)
MAIN:
	MOV P0, #0FFh
	MOV P2, #00h
	
	; 初始化显示缓冲 (6位)
	LCALL LED6_Clear
	
	MOV 038h, #00h

	MOV 070h, #00h
	MOV 071h, #00h

	MOV 044h, #0FFh
	MOV 045h, #00h
	MOV 046h, #0FFh
	MOV 047h, #00h
	MOV 048h, #00h
	MOV 03Ah, #03h
	
	
	MOV TMOD, #011h
	MOV TH1, #0FCh
	MOV TL1, #018h
	MOV TH0, #0D8h
	MOV TL0, #0F0h
	MOV IE,  #08Ah
	SETB TR1      
	SETB TR0      

LOOP:
	LCALL MatrixKey 
	CJNE A,044h,MXK_SAMPLE_CHANGED
	INC 045h
	SJMP MXK_AFTER_STABLE_CHECK

MXK_SAMPLE_CHANGED:
	MOV 044h, A
	MOV 045h, #01

MXK_AFTER_STABLE_CHECK:
	MOV A, 045h
	CJNE A,#03,MXK_STATE_CHECK
	SJMP MXK_CHECK_CONF

MXK_CHECK_CONF:
	MOV A, 046h
	CJNE A,044h,MXK_CONF_CHANGED
	SJMP MXK_STATE_CHECK

MXK_CONF_CHANGED:
	MOV A, 044h
	MOV 046h, A
	MOV A, 048h
	CJNE A, #02h, MXK_CONF_CHECK_RELEASE
	MOV 047h, #00h
	MOV 048h, #00h
	SJMP MXK_STATE_CHECK

MXK_CONF_CHECK_RELEASE:
	MOV A, 044h
	CJNE A,#0FFh,MXK_CONF_PRESSED
	MOV A, 047h
	CLR C
	SUBB A, #064h
	JNC MXK_LONG_PRESS
	SJMP MXK_SHORT_PRESS

MXK_LONG_PRESS:
	MOV 047h, #00h
	MOV 048h, #00h
	SJMP MXK_STATE_CHECK

MXK_SHORT_PRESS:
	MOV 047h, #00h
	MOV 048h, #00h
	SJMP MXK_STATE_CHECK

MXK_CONF_PRESSED:
	MOV A, 044h
	ANL A, #0Fh
	MOV 060h, A
	MOV 061h, #01h
	MOV 047h, #00h
	MOV 048h, #00h

MXK_STATE_CHECK:
	MOV A, 070h
	CJNE A,#RUN_ST, CHECK_OPT
	LCALL RUN_HANDLER
	SJMP LOOP
CHECK_OPT:
	CJNE A,#OPT_ST, CHECK_OPT1
	LCALL OPT_HANDLER
	AJMP LOOP
CHECK_OPT1:
	CJNE A,#OPT1_ST, CHECK_OPT2
	LCALL OPT1_HANDLER
	AJMP LOOP
CHECK_OPT2:
	CJNE A,#OPT2_ST, CHECK_OPT3
	LCALL OPT2_HANDLER
	AJMP LOOP
CHECK_OPT3:
	CJNE A,#OPT3_ST, CHECK_PASS
	LCALL OPT3_HANDLER
	AJMP LOOP
CHECK_PASS:
	CJNE A,#PASS_ST, SKIP_PASS
	LCALL PASS_HANDLER
	AJMP LOOP
SKIP_PASS:
	AJMP LOOP

	; TIMER ISRs moved to bsp/timer0.asm and bsp/timer1.asm (PUBLIC symbols)

;-----------------------------
; 状态机
;-----------------------------

	; RUN and OPT handlers moved to Tasks/ modules


PASS_HANDLER:
		MOV A, 071h
		CJNE A, 070h, PASS_INIT
		MOV A, 061h
		CJNE A, #00h, PASS_HANDLE_KEY
		SJMP PASS_MODE

PASS_HANDLE_KEY:
		MOV A, 060h
		ANL A, #0Fh
		MOV R7, A
		CLR C
		SUBB A, #0Ah
		JNC PASS_SKIP_UPDATE

		; 数字键
		MOV A, 039h
        ADD A, #030h
        MOV R0, A
		MOV A, R7
        MOV @R0, A

		MOV A, 039h
		CJNE A, #0FFh, PASS_KEY_DEC
		SJMP PASS_KEY_DONE

PASS_KEY_DEC:
        DEC 039H

PASS_KEY_DONE:
		MOV 061h, #00h
		SJMP PASS_MODE

PASS_SKIP_UPDATE:
		MOV A, 060h
		CJNE A, #0Bh, PASS_MODE
		; B键回退
		INC 039h
		MOV A, 039h
		CLR C
		SUBB A, #05h
		JNC PASS_BACKSPACE_LIMIT ; 恢复为 4
		MOV A, 039h
		ADD A, #030h
		MOV R0, A
		MOV @R0, #010h
		MOV 061h, #00h
		SJMP PASS_MODE

PASS_BACKSPACE_LIMIT:
		MOV 039h, #04h
		MOV A, 039h
		ADD A, #030h
		MOV R0, A
		MOV @R0, #010h
		MOV 061h, #00h
		SJMP PASS_MODE

PASS_INIT:
		MOV A, 070h
		MOV 071h, A      
		MOV 070h, #PASS_ST
		
		; 显示 "P._____" (6位)
		; 35: P. (0x11)
		; 34~30: _
		LCALL LED6_Show_PASS_INIT
		MOV 039h, #04h     ; 光标位置 4 (Buffer 34h)
		RET

PASS_MODE:
		MOV A, 061h
		CJNE A, #00h, PASS_MODE_CHECK_KEY
		RET

PASS_MODE_CHECK_KEY:
		MOV A, 060h
		CJNE A, #0Ah, PASS_MODE_SKIP_CONFIRM
		
		MOV A, 039h
		CJNE A, #0FFh, PASS_CONFIRM_INCOMPLETE
		LCALL PASS_VERIFY_PASSWORD
		MOV 061h, #00h
		RET

PASS_CONFIRM_INCOMPLETE:
		LCALL PASS_SHOW_ERROR
		MOV 061h, #00h
		RET

PASS_MODE_SKIP_CONFIRM:
		MOV 061h, #00h
		RET

PASS_VERIFY_PASSWORD:
		; 验证 5 位密码 (Buffer 34..30) vs Table 0..4
		MOV R0, #04h    ; Buffer Index
		MOV R3, #00h    ; Table Index

PASS_VERIFY_LOOP:
		MOV A, R0
		ADD A, #030h
		MOV R1, A
		MOV A, @R1      
		MOV R2, A       
		
		MOV DPTR, #PASSWORD_TABLE
		MOV A, R3
		MOVC A, @A+DPTR 
		
		CJNE A, 02h, PASS_VERIFY_FAIL_CHECK
		SJMP PASS_VERIFY_NEXT

PASS_VERIFY_FAIL_CHECK:
		MOV A, R2
		MOV B, A
		MOV A, R3
		MOV DPTR, #PASSWORD_TABLE
		MOVC A, @A+DPTR
		CJNE A, B, PASS_VERIFY_FAIL

PASS_VERIFY_NEXT:
		DEC R0
		INC R3
		MOV A, R3
		CJNE A, #05h, PASS_VERIFY_LOOP ; 5位
		LCALL PASS_SHOW_SUCCESS
		RET

PASS_VERIFY_FAIL:
		LCALL PASS_SHOW_ERROR
		RET

PASS_SHOW_ERROR:
		DEC 03Ah
		MOV A, 03Ah
		JZ PASS_ERROR_LOCKED
		
		; 显示 FALSEX (6位)
		; 35: F (0x0F)
		; 34: A (0x0A)
		; 33: L (0x13)
		; 32: S (0x05)
		; 31: E (0x0E)
		; 30: Count
		LCALL LED6_Show_FALSEX
		
		MOV R3, #06h
PASS_ERROR_DELAY_OUTER:
		MOV R4, #0F0h
PASS_ERROR_DELAY_LOOP:
		MOV R5, #0FFh
PASS_ERROR_DELAY_INNER:
		NOP
		NOP
		NOP
		DJNZ R5, PASS_ERROR_DELAY_INNER
		DJNZ R4, PASS_ERROR_DELAY_LOOP
		DJNZ R3, PASS_ERROR_DELAY_OUTER
		
		AJMP PASS_INIT

PASS_ERROR_LOCKED:
	; Err011 (locked) - use LED6 helper
	LCALL LED6_Show_ERR011
	AJMP PASS_ERROR_LOCKED

PASS_SHOW_SUCCESS:
		MOV 070h, #OPT_ST
		RET

END
