# C8051F020 电梯系统设计报告 (Student 1)

**一、 任务要求**

本实验旨在基于 C8051F020 单片机设计一个多楼层电梯控制系统。要求软件架构清晰，能够处理多任务并发（如显示刷新、按键扫描、电梯运行逻辑）。具体任务包括：
1.  设计分层软件架构，隔离硬件操作与业务逻辑。
2.  实现双层状态机，管理从系统模式（配置/密码/运行）到电梯动作（待机/移动/开关门）的所有状态。
3.  实现基于优先级的任务调度（主循环+中断），确保实时性。
4.  规划系统存储器资源，合理分配 RAM 和 GPIO。

**二、 设计思路**

本系统的软件架构采用分层设计与有限状态机相结合的方式，将整个电梯控制程序划分为硬件抽象层、中间驱动层和应用任务层三个层次。硬件抽象层封装了 C8051F020 单片机的底层操作；中间驱动层构建各类外设驱动；应用任务层实现具体的业务逻辑。

1.  **分层架构设计**
    *   **硬件抽象层**：底层 GPIO 配置、定时器初始化、延时函数。
    *   **中间驱动层**：LED 数码管动态扫描、LCD1602 时序驱动、矩阵键盘扫描与消抖。
    *   **应用任务层**：`main.ASM` 作为调度中心，根据状态分发控制权给 `RunningTask` 或 `ConfigurationTask`。

2.  **双层状态机**
    系统状态管理采用双层状态机架构。主状态机通过 RAM 地址 `070h` 存储当前系统状态（运行、配置、密码验证）。当处于运行模式时，电梯控制子状态机接管，细分为待机 (`0x20`)、运行 (`0x21`)、到达开门 (`0x22`) 和关门 (`0x23`)。
    *   **状态切换检测**：通过对比当前状态 `070h` 与上一状态 `071h`，若不相等则执行状态初始化（如刷新屏幕），避免重复操作。

3.  **调度与通信**
    *   **轮询调度**：主循环持续调用 `KeyInput_Process` 并根据状态跳转任务函数。
    *   **共享 RAM 通信**：模块间通过共享变量通信（如 `060h` 存键值，`061h` 存标志位），采用生产者-消费者模式。
    *   **电梯调度算法**：采用 SCAN 算法。优先响应同向请求（包括内呼和同向外呼），若无则扫描反向最远端请求，确保运行效率。
    *   **请求位图**：使用位图存储 11 个楼层请求（-2F 到 8F），内存占用极小且操作高效。

4.  **后台任务**
    *   **Timer0**：10ms 心跳，负责按键消抖、长按计时、电梯状态计时（如开门 5s）。
    *   **Timer1**：1ms 扫描，负责数码管动态显示。
    *   **Timer2**：PWM 输出，驱动蜂鸣器。

**三、 资源分配**

**3.1 硬件资源分配**
| 资源名称 | 用途/功能 | 配置详情 |
| :--- | :--- | :--- |
| **Timer 0** | 系统心跳 | 16位定时器 (Mode 1), 10ms 周期。负责全局 Tick、消抖、运行计时。 |
| **Timer 1** | 数码管扫描 | 16位定时器 (Mode 1), 1ms 周期。负责 LED6 动态刷新。 |
| **Timer 2** | 蜂鸣器 | 自动重装载模式, PWM 输出。 |
| **P0/P2** | LED 显示 | P0 输出段码，P2 输出位选。 |
| **P1** | 键盘 | 4x4 矩阵键盘，行扫描法。 |
| **P3/P4** | LCD/控制 | P3 数据总线，P4 控制信号 (LCD RS/E, 蜂鸣器)。 |

**3.2 存储器资源分配 (部分)**
| 地址 (RAM) | 功能描述 |
| :--- | :--- |
| **0x28-0x2D** | LED 数码管显存 |
| **0x56** | `CUR_FLr` (当前楼层) |
| **0x57** | `ELEV_TIMER` (状态计时器) |
| **0x58** | `ELEV_TARGET` (目标楼层) |
| **0x5C-0x5F** | `INT_REQ`/`EXT_UP` (请求位图) |
| **0x70** | 系统主状态机 |
| **0x71** | 全局刷新标志 |

-------------------------------------------------------------------------------------------------------------

# C8051F020 外设驱动与运行任务报告 (Student 2)

**一、 任务要求**

本模块任务是设计并实现系统的底层驱动与核心运行逻辑，具体要求包括：
1.  **LCD1602 驱动**：解决 C8051F020 的 SFR 分页问题，实现指令与数据的正确写入。
2.  **LED 数码管驱动**：利用定时中断实现无闪烁的 6 位动态扫描显示。
3.  **电梯运行任务 (Running Task)**：实现电梯到达、开门、因应按键事件的关门及重开门逻辑，并配合显示模块实时反馈状态。

**二、 设计思路**

**1. LCD1602 驱动设计**
由于 C8051F020 的 P4 端口（连接 RS, E）位於 SFR 页 `0Fh`，而标准端口在页 `00h`，因此驱动核心必须处理页切换。
*   **页切换逻辑**：在操作 RS/E 前，保存 ACC，切换 `SFRPAGE` 到 `0Fh` 修改电平，再切回 `00h`。
*   **时序控制**：严格遵循 LCD 时序，在 E 引脚的下降沿锁存数据，并加入适当的延时 (`DELAY_MS`) 等待 LCD 处理。

**2. LED 数码管动态扫描**
采用 Timer1 中断驱动的“分时复用”机制。
*   **刷新机制**：每次中断只点亮一位。流程为：消隐 (关 P0/P2) -> 读显存 -> 查表 (段码) -> 查表 (位选) -> 输出。
*   **视觉暂留**：通过高速切换（>100Hz），实现 6 位数码管看起来同时点亮的效果。
*   **应用接口**：提供 `LED6_ApplyTable` 函数，供上层逻辑一次性更新整屏显示内容。

**3. 电梯运行任务逻辑 (RunningTask)**
重点实现了电梯到达后的状态流转：
*   **到达 (Arrived)**: 状态 `0x22`，设置 5s 倒计时。LCD 显示 "Open"，LED 显示 "OP" 闪烁。
*   **关门 (Close)**: 状态 `0x23`，倒计时结束或按关门键触发。设置 2s 倒计时。LCD 显示 "Close"，LED 显示 "CL" 闪烁。
*   **防夹/重开门**: 在关门过程中，若检测到本层呼叫或 'C' 键（开门键），立即跳转回 Arrived 状态并重置 5s 计时。
*   **逻辑复用**: 待机状态下检测到本层呼叫，直接利用 `EH_OPEN_NOW` 子程序触发直接开门。

**三、 资源分配**

**1. RAM 缓冲区分配**
*   **显示缓冲区 (`0x28-0x2D`)**: 存放 6 个字节的显示数据索引，驱动层直接读取此区域。
*   **扫描索引 (`0x38`)**: 记录当前正在刷新的数码管位置 (0-5)。

**2. 端口分配**
*   **P3 (Data), P4.6 (RS), P4.7 (E)**: LCD 控制接口。
*   **P0 (Segment), P2 (Digit)**: LED 数码管接口。

**3. 关键函数接口**
*   `LCD_WR_CMD` / `LCD_WR_DAT`: LCD 底层写操作。
*   `LED6_Refresh`: 定时中断调用的刷新函数。
*   `ELEV_ARRIVED_HANDLER`: 到达与开门逻辑处理。

-------------------------------------------------------------------------------------------------------------

# C8051F020 进阶调度与功能增强报告 (Student 3)

**一、 任务要求**

在基础电梯功能之上，本模块着重实现智能化与人性化的进阶功能，主要任务包括：
1.  **高级调度算法**：实现空闲自动停泊算法，提高系统响应速度。
2.  **交互增强**：设计梯内/梯外双重输入模式，模拟真实电梯操作。
3.  **运行优化**：实现运行状态下的“顺向截停”功能，避免无效往返。
4.  **底层优化**：优化矩阵键盘扫描算法与定时器驱动。

**二、 设计思路**

**1. 空闲自动停泊 (Idle Parking)**
*   **触发机制**：当 `SCAN` 算法检测到所有请求队列为空且电梯处于待机状态时触发。
*   **分区停泊策略**：
    *   当前楼层索引 < 6 (低层区)：自动移动至 **1楼** 待命。
    *   当前楼层索引 >= 6 (高层区)：自动移动至 **8楼** 待命。
    *   此策略能有效减少新请求到达时的平均等待时间。

**2. 双模输入与交互 (Dual Input Mode)**
*   **模式切换**：通过 'A' 键在 RAM `065h` 中切换 `INPUT_MODE`。
*   **Inside 模式**：数字键直接作为内呼请求 (`INT_REQ`)。
*   **Outside 模式**：采用“先选层、后选向”逻辑。输入数字选定楼层，再按 'E'(上)/'F'(下) 将请求写入外呼队列 (`EXT_UP`/`EXT_DN`)。

**3. 顺向截停 (En-route Interception)**
在电梯移动过程中 (`ELEV_RUN`)，每经过一层都会立即调用 `CHECK_FLOOR_REQUEST`。
*   **逻辑**：若当前楼层有与运行方向一致的请求（如上行时有上行呼叫），立即清除请求并强制切换到开门状态，无需先到达目标层。

**4. 驱动优化**
*   **Timer0**：作为系统核心 Tick，不仅处理任务调度，还内嵌了按键长按检测逻辑。
*   **键盘驱动**：采用逐列扫描法，结合软件消抖算法（3次采样一致性确认），有效消除了机械抖动误判。

**三、 资源分配**

**1. 核心变量**
| 变量名 | 地址 | 功能 |
| :--- | :--- | :--- |
| `INPUT_MODE` | **0x65** | 0=Internal, 1=External (Interaction Mode) |
| `ELEV_DIR` | **0x64** | 运行方向 (0=Stop, 1=Up, 2=Down) |
| `Timer0` | - | 负责系统时基与运行计时 |

**2. 算法资源**
*   **停泊检测**：利用 `ELEV_TIMER` (`057h`) 进行空闲计时，避免频繁启停。
*   **扫描算法**：复用请求位图 (`INT_REQ`, `EXT_UP`, `EXT_DN`) 进行逻辑判断。

-------------------------------------------------------------------------------------------------------------

# 《单片机与嵌入式系统实验》报告 (Student 4)

**一、任务要求**
1. **中间层设计**：在 `KeyInput.asm`、`KBI.asm` 和 `LED6.asm` 中设计并实现连接底层硬件驱动（矩阵键盘、数码管、LCD）与上层应用逻辑的中间件。重点解决按键的物理消抖、输入缓冲区的游标管理以及显示内容的抽象化映射。
2. **电梯执行逻辑实现**：在 `RunningTask.asm` 中实现电梯的动作执行层，计算运行参数（方向、时间），控制状态机流转（运行/停止/开关门），并驱动显示层实时反馈电梯状态。
3. **输入任务管理**：在 `InputTask.asm` 中实现基于光标的通用输入任务，支持数字输入、退格与确认逻辑，用于系统配置及密码验证。

**二、设计思路**

本实验采用分层架构设计，将系统分为驱动层、中间层和应用层。我主要负责中间层及核心运行任务的实现。

**1. 电梯动作执行 (RunningTask)**
电梯的运行逻辑是一个复杂的状态机，配合位图存储请求与两轮扫描算法，我们在 `RunningTask.asm` 中定义了 `RUN_ST` (总入口), `ELEV_ST` (待机), `ELEV_RUN` (运行), `ELEV_ARRIVED` (到达开门), `ELEV_CLOSE` (关门) 这五个主状态；使用位图存储楼层请求，将 -2F 至 8F 映射为 Index 0~10；设置 `INT_REQ` 用于内选请求、`EXT_UP`/`EXT_DN` 用于外呼上行/下行请求。
在电梯调度逻辑方面，我们采用了两轮扫描法：
*   **第一轮严格扫描**：基于当前方向，寻找同向的内选或外呼请求，遵循“就近原则”，一旦发现立即响应，实现顺向截停。
*   **第二轮宽松扫描**：若同向无请求，则寻找反向的外呼请求。

**2. 按键消抖逻辑 (KeyInput)**
`KeyInput.asm` 实现了软件消抖。在每次调用时，先读取物理键值，并与上一次的采样值 (`044H`) 对比。如果键值发生变化，则重置计数器 `045H`；如果键值保持不变，则计数器累加。当且仅当计数器达到预设的采样阈值（3次）时，才认为按键有效，并将其写入系统键值缓冲区 `060H`。

**3. 输入任务 (InputTask)**
`InputTask.asm` 使得输入逻辑可以复用。我们通过 `startIndex` (`020H`) 和 `endIndex` (`021h`) 定义输入区域，进行游标管理：
*   数字键 0-9：写入当前游标并右移。
*   退格键 0x0B：清除当前位或左移清除。
*   确认键 0x0A：触发回调。

**三、资源分配**

本部分实验主要使用了以下 RAM 资源与寄存器：
1.  **全局状态与标志位**
    *   `070H`: 系统主状态机
    *   `071H`: 状态机刷新标志
    *   `050H~054H`: 配置参数存储区
2.  **输入系统资源**
    *   `060H`: 有效键值
    *   `061H`: 按键就绪标志
    *   `044H~048H`: 消抖过程变量
    *   `020H` / `021H`: 输入任务起始/结束索引
    *   `03BH` / `039H`: 当前光标位置指针
3.  **电梯运行核心数据**
    *   `056H (CUR_FLr)`: 当前楼层
    *   `058H (ELEV_TARGET)`: 目标楼层
    *   `057H (ELEV_TIMER)`: 运行倒计时定时器
    *   `INT_REQ`, `EXT_UP`, `EXT_DN`: 请求位图
4.  **显示缓冲区**
    *   `028H~02DH`: 6 位 LED 数码管显存
