A51 MACRO ASSEMBLER  RUNNINGTASK                                                          01/10/2026 10:26:27 PAGE     1


MACRO ASSEMBLER A51 V8.2.7.0
OBJECT MODULE PLACED IN .\Objects\runningTask.obj
ASSEMBLER INVOKED BY: C:\Keil_v5\C51\BIN\A51.EXE Tasks\runningTask.asm NOMOD51 SET(SMALL) DEBUG PRINT(.\Listings\running
                      Task.lst) OBJECT(.\Objects\runningTask.obj) EP

LOC  OBJ            LINE     SOURCE

                       1     ; Running task: handles RUN state logic moved from main.ASM
                       2     Running SEGMENT CODE
----                   3     rseg Running
                       4     
                       5     ;$include (../user/config.inc)
                +1     6     ; 索引�? 0 开始，�? main.ASM 中通过偏移访问 (MOVC @A+DPTR)
                +1     7     ; 00 - '0'  - 0C0h
                +1     8     ; 01 - '1'  - 0F9h
                +1     9     ; 02 - '2'  - 0A4h
                +1    10     ; 03 - '3'  - 0B0h
                +1    11     ; 04 - '4'  - 099h
                +1    12     ; 05 - '5'  - 092h
                +1    13     ; 06 - '6'  - 082h
                +1    14     ; 07 - '7'  - 0F8h
                +1    15     ; 08 - '8'  - 080h
                +1    16     ; 09 - '9'  - 090h
                +1    17     ; 10 - 'A'  - 088h
                +1    18     ; 11 - 'b'  - 083h
                +1    19     ; 12 - 'C'  - 0C6h
                +1    20     ; 13 - 'd'  - 0A1h
                +1    21     ; 14 - 'E'  - 086h
                +1    22     ; 15 - 'F'  - 08Eh
                +1    23     ; 16 - '_'  - 0F7h
                +1    24     ; 17 - 'P.' - 00Ch
                +1    25     ; 18 - 'r'  - 0AFh
                +1    26     ; 19 - 'L'  - 047h
                +1    27     ; 20 - '0.' - 040h
                +1    28     ; 21 - '1.' - 079h
                +1    29     ; 22 - '2.' - 024h
                +1    30     ; 23 - '3.' - 030h
                +1    31     ; 24 - '4.' - 019h
                +1    32     ; 25 - '5.' - 012h
                +1    33     ; 26 - '6.' - 002h
                +1    34     ; 27 - '7.' - 078h
                +1    35     ; 28 - '8.' - 000h
                +1    36     ; 29 - '9.' - 010h
                +1    37     ; 30 - 'n'  - 0ABh
                +1    38     ; 31 - 'o'  - 0A3h
                +1    39     ; 32 - 'o.' - 023h
                +1    40     ; 33 - OFF  - 0FFh    ; 熄灭 (全部段关�?)
                +1    41     ; 34 - 'C.' - 046h    ; 自定�? C 带小数点
                +1    42     ; 35 - 'U'  - 0C1h
                +1    43     ; 36 - '-'  - 0BFh
                +1    44     ; 37 - ' '  - 0FFh
                +1    45     
0000            +1    46     SEG_TABLE:
0000 C0F9A4B0   +1    47         DB 0C0h,0F9h,0A4h,0B0h,099h,092h,082h,0F8h,080h,090h,088h,083h,0C6h,0A1h,086h,08Eh,0F7h
                             ,00Ch,0AFh,047h
0004 999282F8                
0008 80908883                
000C C6A1868E                
0010 F70CAF47                
0014 40792430   +1    48         DB 040h,079h,024h,030h,019h,012h,002h,078h,000h,010h
0018 19120278                
001C 0010                    
001E ABA323FF   +1    49         DB 0ABh,0A3h,023h,0FFh,046h,0C1h,0BFh,0FFh
0022 46C1BFFF                
A51 MACRO ASSEMBLER  RUNNINGTASK                                                          01/10/2026 10:26:27 PAGE     2

                +1    50     
0026            +1    51     BITMASK_TABLE:
0026 80402010   +1    52         DB 080h,040h,020h,010h,008h,004h
002A 0804                    
                +1    53     
002C            +1    54     PASSWORD_TABLE:
002C 01020304   +1    55         DB 01h,02h,03h,04h,05h
0030 05                      
                +1    56     
                +1    57     ; RUN_ST, OPT_ST, PASS_ST, OPT1_ST, OPT2_ST, OPT3_ST
  0000          +1    58     RUN_ST  EQU     00h
  0001          +1    59     OPT_ST  EQU     01h
  0002          +1    60     PASS_ST EQU     02h
  0003          +1    61     RESET_CHOICE_ST EQU 03h
  0004          +1    62     NEW_PASS_ST EQU 04h
  0011          +1    63     OPT1_ST EQU     11h
  0012          +1    64     OPT2_ST EQU     12h
  0013          +1    65     OPT3_ST EQU     13h
                +1    66     
                +1    67     ; Elevator states
  0020          +1    68     ELEV_ST EQU 20h
  0021          +1    69     ELEV_RUN EQU 21h
  0022          +1    70     ELEV_ARRIVED EQU 22h
  0023          +1    71     ELEV_CLOSE EQU 23h
                +1    72     
                +1    73     ; Elevator variables (RAM)
  0056          +1    74     CUR_FLr      EQU 056h
  0057          +1    75     ELEV_TIMER   EQU 057h
  0058          +1    76     ELEV_TARGET  EQU 058h
  0059          +1    77     ONE_SEC_CNT  EQU 059h
  005A          +1    78     BLINK_TIMER  EQU 05Ah
  005B          +1    79     BLINK_TOGGLE EQU 05Bh
                +1    80     
                +1    81     ; Queue variables (BITMAP based - 11 floors: -2 to 8)
                +1    82     ; Bit 0 = Floor -2, Bit 1 = Floor -1, Bit 2 = Floor 1, ... Bit 10 = Floor 8
                +1    83     ; Use 2 bytes: Low byte (bits 0-7), High byte (bits 8-10)
  005C          +1    84     INT_REQ_LO     EQU 05Ch  ; Internal request bitmap low (floors -2 to 5)
  005D          +1    85     INT_REQ_HI     EQU 05Dh  ; Internal request bitmap high (floors 6 to 8)
  005E          +1    86     EXT_UP_LO      EQU 05Eh  ; External UP request bitmap low
  005F          +1    87     EXT_UP_HI      EQU 05Fh  ; External UP request bitmap high
  0062          +1    88     EXT_DN_LO      EQU 062h  ; External DOWN request bitmap low
  0063          +1    89     EXT_DN_HI      EQU 063h  ; External DOWN request bitmap high
  0064          +1    90     ELEV_DIR       EQU 064h  ; Current direction: 0=停止, 1=�?, 2=�?
                +1    91     
                +1    92     ; Input Mode variables
  0065          +1    93     INPUT_MODE     EQU 065h ; 0=Inside, 1=Outside
  0066          +1    94     OUT_SEL_VAL    EQU 066h ; Temp storage for outside floor selection
  0067          +1    95     DEBUG_ON       EQU 067h ; Global debug flag: 0=normal, 1=jump to debug task
                +1    96     
                +1    97     ; New variables for Reset Password feature
  0068          +1    98     CURRENT_PASS   EQU 068h ; 5 bytes [068h..06Ch] holding current password in RAM
  006D          +1    99     PASS_NEXT_ST   EQU 06Dh ; State to jump to after PASS_ST success (allows reuse)
                +1   100     
                +1   101     ; Floor to Bit Index mapping:
                +1   102     ; Floor -2 -> Index 0
                +1   103     ; Floor -1 -> Index 1
                +1   104     ; Floor  1 -> Index 2
                +1   105     ; Floor  2 -> Index 3
                +1   106     ; ...
                +1   107     ; Floor  8 -> Index 10
                +1   108     ; Formula: Index = Floor + 2 (if Floor >= 1, Index = Floor + 1)
                     109     
                     110     ;$include (../driver/LCD1602.inc)
                +1   111     EXTRN CODE(LCD_INIT)
                +1   112     EXTRN CODE(LCD_WR_CMD)
                +1   113     EXTRN CODE(LCD_WR_DAT)
A51 MACRO ASSEMBLER  RUNNINGTASK                                                          01/10/2026 10:26:27 PAGE     3

                +1   114     EXTRN CODE(LCD_CLEAR)
                +1   115     EXTRN CODE(LCD_SHOW_STR)
                     116     
                     117     
                     118     EXTRN CODE(LED6_ApplyTable)
                     119     EXTRN CODE(Singer_PlayNote) ; Import Singer_PlayNote
                     120     
                     121     PUBLIC RunningTask_Init
                     122     PUBLIC RunningTask_Handler
                     123     
                     124     ; LCD Strings
0031                 125     LCD_MSG_INSIDE:
0031 496E7369        126         DB 'I','n','s','i','d','e',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 00h
0035 64652020                
0039 20202020                
003D 20202020                
0041 00                      
0042                 127         LCD_MSG_WELCOME:
0042 57656C63        128         DB 'W','e','l','c','o','m','e',' ',' ',' ',' ',' ',' ',' ',' ',' ', 00h
0046 6F6D6520                
004A 20202020                
004E 20202020                
0052 00                      
0053                 129     LCD_STR_OUT_PREFIX:
0053 4F75743A        130         DB 'O','u','t',':',' ', 00h
0057 2000                    
0059                 131     LCD_STR_UP:
0059 55702020        132         DB 'U','p',' ',' ', 00h
005D 00                      
005E                 133     LCD_STR_DOWN:
005E 446F776E        134         DB 'D','o','w','n', 00h
0062 00                      
0063                 135     LCD_STR_EMPTY:
0063 20202020        136         DB ' ',' ',' ',' ', 00h
0067 00                      
                     137     
0068                 138     LCD_MSG_OPEN:
0068 2020206F        139         DB ' ',' ',' ','o','p','e','n',' ','d','o','o','r',' ',' ',' ',' ', 00h
006C 70656E20                
0070 646F6F72                
0074 20202020                
0078 00                      
0079                 140     LCD_MSG_CLOSE:
0079 20202063        141         DB ' ',' ',' ','c','l','o','s','e',' ','d','o','o','r',' ',' ',' ', 00h
007D 6C6F7365                
0081 20646F6F                
0085 72202020                
0089 00                      
008A                 142     LCD_MSG_RUN:
008A 20202052        143         DB ' ',' ',' ','R','u','n','n','i','n','g','.','.','.',' ',' ',' ', 00h
008E 756E6E69                
0092 6E672E2E                
0096 2E202020                
009A 00                      
009B                 144     LCD_MSG_FL:
009B 464C3A20        145         DB 'F','L',':',' ', 00h
009F 00                      
                     146     
                     147     ; Initialize running task: set up elevator defaults
00A0                 148     RunningTask_Init:
00A0 755601          149         MOV CUR_FLr, #01h      ; 默认 1楼
00A3 755900          150         MOV ONE_SEC_CNT, #00h
00A6 755700          151         MOV ELEV_TIMER, #00h
00A9 755801          152         MOV ELEV_TARGET, #01h
                     153         
                     154         ; Init Request Bitmaps (all clear)
A51 MACRO ASSEMBLER  RUNNINGTASK                                                          01/10/2026 10:26:27 PAGE     4

00AC 755C00          155         MOV INT_REQ_LO, #00h
00AF 755D00          156         MOV INT_REQ_HI, #00h
00B2 755E00          157         MOV EXT_UP_LO, #00h
00B5 755F00          158         MOV EXT_UP_HI, #00h
00B8 756200          159         MOV EXT_DN_LO, #00h
00BB 756300          160         MOV EXT_DN_HI, #00h
00BE 756400          161         MOV ELEV_DIR, #00h     ; Stopped
                     162         
                     163         ; Init Input Mode
00C1 756500          164         MOV INPUT_MODE, #00h   ; Default Inside
00C4 756601          165         MOV OUT_SEL_VAL, #01h  ; Default selection
                     166         
                     167         ; Init LCD
00C7 120000   F      168         LCALL LCD_INIT
00CA 120000   F      169         LCALL LCD_CLEAR
00CD 900000   F      170         MOV DPTR, #LCD_MSG_WELCOME
00D0 120000   F      171         LCALL LCD_SHOW_STR
00D3 22              172         RET
                     173     
                     174     ; Handler implements the RUN_HANDLER logic from main.ASM
00D4                 175     RunningTask_Handler:
                     176         ; Dispatcher: RUN or ELEV states
00D4 E570            177         MOV A, 070h
00D6 B4003C          178         CJNE A, #RUN_ST, CHECK_ELEV_RUN
                     179         ; RUN state
00D9 E571            180         MOV A, 071h
00DB B5701C          181         CJNE A, 070h, RT_INIT
                     182     
00DE E561            183         MOV A, 061h
00E0 B40002          184         CJNE A, #00h, RT_HANDLE_KEY
00E3 801B            185         SJMP RT_MODE
                     186     
00E5                 187     RT_HANDLE_KEY:
00E5 E560            188         MOV A, 060h
00E7 B48A0B          189         CJNE A, #08Ah, RT_HANDLE_OTHER
00EA 757002          190         MOV 070h, #PASS_ST
00ED 756D01          191         MOV PASS_NEXT_ST, #OPT_ST
00F0 756100          192         MOV 061h, #00h
00F3 800B            193         SJMP RT_MODE
                     194     
00F5                 195     RT_HANDLE_OTHER:
00F5 756100          196         MOV 061h, #00h
00F8 8006            197         SJMP RT_MODE
                     198     
00FA                 199     RT_INIT:
00FA E570            200         MOV A, 070h
00FC F571            201         MOV 071h, A
00FE 8000            202         SJMP RT_MODE
                     203     
0100                 204     RT_MODE:
                     205         ; 检查配置是否完成 (050h!=10h 表示 OPT1 已设置)
0100 E550            206         MOV A, 050h
0102 B41009          207         CJNE A, #010h, RT_CONFIG_DONE
                     208         ; 未完成配置，显示空白等待
0105 7401            209         MOV A, #01h
0107 120000   F      210         LCALL LED6_ApplyTable
010A 753904          211         MOV 039h, #04h
010D 22              212         RET
010E                 213     RT_CONFIG_DONE:
                     214         ; 配置完成，切换到电梯待机状态
010E 757020          215         MOV 070h, #ELEV_ST
0111 7571FF          216         MOV 071h, #0FFh        ; 强制刷新
0114 22              217         RET
                     218     
0115                 219     CHECK_ELEV_RUN:
0115 B42004          220         CJNE A, #ELEV_ST, CHECK_ELEV_RUN2
A51 MACRO ASSEMBLER  RUNNINGTASK                                                          01/10/2026 10:26:27 PAGE     5

0118 120000   F      221         LCALL ELEV_HANDLER
011B 22              222         RET
011C                 223     CHECK_ELEV_RUN2:
011C B42104          224         CJNE A, #ELEV_RUN, CHECK_ELEV_ARR
011F 120000   F      225         LCALL ELEV_RUN_HANDLER
0122 22              226         RET
0123                 227     CHECK_ELEV_ARR:
0123 B42204          228         CJNE A, #ELEV_ARRIVED, CHECK_ELEV_CLOSE
0126 120000   F      229         LCALL ELEV_ARRIVED_HANDLER
0129 22              230         RET
012A                 231     CHECK_ELEV_CLOSE:
012A B42304          232         CJNE A, #ELEV_CLOSE, RT_RETURN
012D 120000   F      233         LCALL ELEV_CLOSE_HANDLER
0130 22              234         RET
0131                 235     RT_RETURN:
0131 22              236         RET
                     237     
                     238     ; --------------------
                     239     ; Elevator handlers (ported from teammate code)
                     240     ; Uses variables: CUR_FLr (056h), ELEV_TIMER (057h), ELEV_TARGET (058h), ONE_SEC_CNT (059h)
                     241     ; --------------------
                     242     
0132                 243     ELEV_HANDLER:
0132 E571            244         MOV A, 071h
0134 B57062          245         CJNE A, 070h, ELEV_INIT
                     246         
                     247         ; 1. Check for new key input and set bitmap
0137 120000   F      248         LCALL CHECK_AND_SET_REQUEST
                     249     
                     250         ; --- Added: Idle Open Logic ---
                     251         ; Check Internal Open Key ('C')
013A E561            252         MOV A, 061h
013C 6009            253         JZ EH_CHECK_CUR_FL
013E E560            254         MOV A, 060h
0140 540F            255         ANL A, #0Fh
0142 B40C02          256         CJNE A, #0Ch, EH_CHECK_CUR_FL
                     257         ; 'C' pressed -> Open
0145 800C            258         SJMP EH_OPEN_NOW
                     259     
0147                 260     EH_CHECK_CUR_FL:
                     261         ; Check request at current floor (Int/Ext)
0147 AE56            262         MOV R6, CUR_FLr
0149 120000   F      263         LCALL CHECK_FLOOR_REQUEST
014C 5018            264         JNC EH_SCAN
                     265         ; Request at current floor -> Open
014E 120000   F      266         LCALL CLEAR_FLOOR_REQUEST
0151 8000            267         SJMP EH_OPEN_NOW
                     268         ; ------------------------------
                     269     
0153                 270     EH_OPEN_NOW:
0153 757022          271         MOV 070h, #ELEV_ARRIVED
0156 755705          272         MOV ELEV_TIMER, #05h
0159 755900          273         MOV ONE_SEC_CNT, #00h
015C 756400          274         MOV ELEV_DIR, #00h     ; Force Stop for Idle Open
                     275         ; Consume key to prevent double-trigger (Fix: Blinking 10 times bug)
015F 756100          276         MOV 061h, #00h
0162 7571FF          277         MOV 071h, #0FFh
0165 22              278         RET
                     279     
0166                 280     EH_SCAN:
                     281         ; 2. Find next target using SCAN algorithm
0166 120000   F      282         LCALL SCAN_FIND_NEXT_TARGET
0169 5009            283         JNC ELEV_NO_REQ        ; No request, check wait/park
                     284         
                     285         ; R6 has target floor
016B EE              286         MOV A, R6
A51 MACRO ASSEMBLER  RUNNINGTASK                                                          01/10/2026 10:26:27 PAGE     6

                     287         
                     288         ; Check if target == current
016C B5560D          289         CJNE A, CUR_FLr, ELEV_START_MOVE
                     290         
                     291         ; Target == Current -> Clear request and Open Door
016F 120000   F      292         LCALL CLEAR_FLOOR_REQUEST  ; Clear request for R6
0172 80DF            293         SJMP EH_OPEN_NOW
                     294     
0174                 295     ELEV_NO_REQ:
                     296         ; No requests found. Check 5s Wait.
0174 E557            297         MOV A, ELEV_TIMER
0176 6006            298         JZ ELEV_CHECK_PARK     ; Timer expired (0) -> Check Parking
0178 756400          299         MOV ELEV_DIR, #00h     ; Stay Idle
017B 22              300         RET
                     301     
017C                 302     ELEV_START_MOVE:
                     303         ; Target != Current -> Start Moving
017C 8026            304         SJMP ELEV_DIFF
                     305     
017E                 306     ELEV_CHECK_PARK:
                     307         ; No requests: Decide Parking Floor (1 or 8) based on proximity
                     308         ; Index 2 (Flr 1) vs Index 9 (Flr 8). Split at Floor 4/5.
017E AE56            309         MOV R6, CUR_FLr
0180 120000   F      310         LCALL FLOOR_TO_INDEX  ; R4 = Current Index
0183 EC              311         MOV A, R4
0184 B40500          312         CJNE A, #05h, ECP_TEST
0187                 313     ECP_TEST:
0187 5004            314         JNC ECP_GO_8          ; If A >= 6 (Floor 5+), Go Floor 8
                     315         
0189 7E01            316         MOV R6, #01h          ; Else Go Floor 1
018B 8002            317         SJMP ECP_EXEC
                     318         
018D                 319     ECP_GO_8:
018D 7E08            320         MOV R6, #08h
                     321     
018F                 322     ECP_EXEC:
018F EE              323         MOV A, R6
0190 B55604          324         CJNE A, CUR_FLr, ECP_MOVE
                     325         ; Already at parking floor -> Idle
0193 756400          326         MOV ELEV_DIR, #00h
0196 22              327         RET
0197                 328     ECP_MOVE:
                     329         ; Not at parking floor -> Move to target (R6)
0197 800B            330         SJMP ELEV_DIFF
                     331     
0199                 332     ELEV_INIT:
0199 E570            333         MOV A, 070h
019B F571            334         MOV 071h, A
019D 120000   F      335         LCALL LCD_CLEAR
01A0 120000   F      336         LCALL SHOW_OPEN_FLOOR
01A3 22              337         RET
                     338     
01A4                 339     ELEV_DIFF:
01A4 8E58            340         MOV ELEV_TARGET, R6
                     341         
                     342         ; Determine direction using Index comparison (avoids signed number issues)
                     343         ; Convert Target to Index
01A6 C006            344         PUSH 06h              ; Save R6
01A8 120000   F      345         LCALL FLOOR_TO_INDEX
01AB EC              346         MOV A, R4
01AC FB              347         MOV R3, A             ; R3 = Target Index
                     348         
                     349         ; Convert Current to Index
01AD AE56            350         MOV R6, CUR_FLr
01AF 120000   F      351         LCALL FLOOR_TO_INDEX  ; R4 = Current Index
01B2 D006            352         POP 06h               ; Restore R6 (Target Floor)
A51 MACRO ASSEMBLER  RUNNINGTASK                                                          01/10/2026 10:26:27 PAGE     7

                     353         
                     354         ; Compare: if Target Index > Current Index, go up
01B4 EB              355         MOV A, R3
01B5 C3              356         CLR C
01B6 9C              357         SUBB A, R4            ; A = Target Index - Current Index
01B7 400B            358         JC E_GO_DOWN
01B9 6009            359         JZ E_GO_DOWN          ; Should not happen, but safety
                     360         ; Go Up
01BB 756401          361         MOV ELEV_DIR, #01h
01BE 7D23            362         MOV R5, #35           ; 'U'
01C0 F557            363         MOV ELEV_TIMER, A     ; Travel time = index difference
01C2 800A            364         SJMP E_START
01C4                 365     E_GO_DOWN:
01C4 756402          366         MOV ELEV_DIR, #02h
01C7 7D0D            367         MOV R5, #13           ; 'd'
                     368         ; Calculate travel time = Current Index - Target Index
01C9 EC              369         MOV A, R4
01CA C3              370         CLR C
01CB 9B              371         SUBB A, R3
01CC F557            372         MOV ELEV_TIMER, A
                     373         
01CE                 374     E_START:
01CE 757021          375         MOV 070h, #ELEV_RUN
01D1 756100          376         MOV 061h, #00h
                     377         
                     378         ; LCD Update
01D4 120000   F      379         LCALL LCD_CLEAR
01D7 900000   F      380         MOV DPTR, #LCD_MSG_RUN
01DA 120000   F      381         LCALL LCD_SHOW_STR
                     382         
01DD 8D28            383         MOV 028h, R5           ; Dir
01DF 752925          384         MOV 029h, #37          ; Space
                     385         
01E2 120000   F      386         LCALL UPDATE_CUR_DISPLAY
01E5 120000   F      387         LCALL UPDATE_TGT_DISPLAY
                     388         
01E8 22              389         RET
                     390     
01E9                 391     ELEV_RUN_HANDLER:
                     392         ; Running display handled by buffer written in E_START
01E9 E571            393         MOV A, 071h
01EB B57020          394         CJNE A, 070h, ER_INIT
                     395         
                     396         ; Update Display with CUR_FLr (Dynamic Update)
01EE 120000   F      397         LCALL UPDATE_CUR_DISPLAY
                     398     
                     399         ; Check if we should stop at current floor (途中停靠)
01F1 AE56            400         MOV R6, CUR_FLr
01F3 120000   F      401         LCALL CHECK_FLOOR_REQUEST
01F6 5012            402         JNC ER_CHK_INT_KEY     ; No request at current floor
                     403         
                     404         ; There's a request at current floor!
                     405         ; Clear the request
01F8 AE56            406         MOV R6, CUR_FLr
01FA 120000   F      407         LCALL CLEAR_FLOOR_REQUEST
                     408         
                     409         ; Transition to Arrived
01FD 757022          410         MOV 070h, #ELEV_ARRIVED
0200 755705          411         MOV ELEV_TIMER, #05h
0203 755900          412         MOV ONE_SEC_CNT, #00h
0206 7571FF          413         MOV 071h, #0FFh
0209 22              414         RET
                     415     
020A                 416     ER_CHK_INT_KEY:
                     417         ; Listen for new keys
020A 120000   F      418         LCALL CHECK_AND_SET_REQUEST
A51 MACRO ASSEMBLER  RUNNINGTASK                                                          01/10/2026 10:26:27 PAGE     8

020D 22              419         RET
                     420     
020E                 421     ER_INIT:
020E E570            422         MOV A, 070h
0210 F571            423         MOV 071h, A
0212 22              424         RET
                     425     
0213                 426     ELEV_ARRIVED_HANDLER:
                     427         ; Fix race condition: check if state changed by ISR
0213 E570            428         MOV A, 070h
0215 B42202          429         CJNE A, #ELEV_ARRIVED, EA_CHECK_INIT
0218 8001            430         SJMP EA_CHECK_INIT_OK
021A                 431     EA_CHECK_INIT:
021A 22              432         RET
021B                 433     EA_CHECK_INIT_OK:
021B E571            434         MOV A, 071h
021D B57051          435         CJNE A, 070h, EA_INIT
                     436         
                     437         ; Check D key (Close)
0220 E561            438         MOV A, 061h
0222 6017            439         JZ EA_CHECK_REQ
0224 E560            440         MOV A, 060h
0226 540F            441         ANL A, #0Fh
0228 B40D10          442         CJNE A, #0Dh, EA_CHECK_REQ
                     443         ; D pressed -> Close
022B 757023          444         MOV 070h, #ELEV_CLOSE
022E 755702          445         MOV ELEV_TIMER, #02h
0231 755900          446         MOV ONE_SEC_CNT, #00h
0234 7571FF          447         MOV 071h, #0FFh
0237 756100          448         MOV 061h, #00h
023A 22              449         RET
                     450     
023B                 451     EA_CHECK_REQ:
                     452         ; Check for floor keys to set bitmap
023B 120000   F      453         LCALL CHECK_AND_SET_REQUEST
023E 8000            454         SJMP EA_BLINK_LOGIC
                     455     
0240                 456     EA_BLINK_LOGIC:
0240 E559            457         MOV A, ONE_SEC_CNT
0242 C3              458         CLR C
0243 9432            459         SUBB A, #50
0245 5008            460         JNC EA_OFF
                     461         ; ON
0247 752814          462         MOV 028h, #20          ; '0.'
024A 752911          463         MOV 029h, #17          ; 'P.'
024D 8006            464         SJMP EA_TAIL
024F                 465     EA_OFF:
                     466         ; OFF
024F 752825          467         MOV 028h, #37          ; ' '
0252 752925          468         MOV 029h, #37          ; ' '
0255                 469     EA_TAIL:
0255 752A25          470         MOV 02Ah, #37          ; ' '
0258 752B25          471         MOV 02Bh, #37          ; ' '
025B E556            472         MOV A, CUR_FLr
025D 20E707          473         JB ACC.7, ARR_NEG
0260 752C25          474         MOV 02Ch, #37          ; ' '
0263 85562D          475         MOV 02Dh, CUR_FLr
0266 22              476         RET
0267                 477     ARR_NEG:
0267 752C24          478         MOV 02Ch, #36          ; '-'
026A E556            479         MOV A, CUR_FLr
026C F4              480         CPL A
026D 04              481         INC A
026E F52D            482         MOV 02Dh, A
0270 22              483         RET
0271                 484     EA_INIT:
A51 MACRO ASSEMBLER  RUNNINGTASK                                                          01/10/2026 10:26:27 PAGE     9

                     485         ; Play sound only if not reopening from CLOSE state
0271 E571            486         MOV A, 071h
0273 B42302          487         CJNE A, #ELEV_CLOSE, EA_CHECK_MOVE
0276 8009            488         SJMP EA_OFFSET_UPDATE
                     489     
0278                 490     EA_CHECK_MOVE:
                     491         ; Only play sound if Elevator was moving (DIR != 0)
0278 E564            492         MOV A, ELEV_DIR
027A 6005            493         JZ EA_OFFSET_UPDATE
                     494     
027C                 495     EA_PLAY_SOUND:
                     496         ; Sound the Arrival Tone
027C AF56            497         MOV R7, CUR_FLr
027E 120000   F      498         LCALL Singer_PlayNote
                     499     
0281                 500     EA_OFFSET_UPDATE:
0281 E570            501         MOV A, 070h
0283 F571            502         MOV 071h, A
                     503         
                     504         ; Clear request for current floor (arrived at target)
0285 AE56            505         MOV R6, CUR_FLr
0287 120000   F      506         LCALL CLEAR_FLOOR_REQUEST
                     507     
                     508         ; LCD Update
028A 120000   F      509         LCALL LCD_CLEAR
028D 900000   F      510         MOV DPTR, #LCD_MSG_OPEN
0290 120000   F      511         LCALL LCD_SHOW_STR
                     512         
0293 22              513         RET
                     514     
0294                 515     ELEV_CLOSE_HANDLER:
                     516         ; Fix race condition: check if state changed by ISR
0294 E570            517         MOV A, 070h
0296 B42302          518         CJNE A, #ELEV_CLOSE, EC_CHECK_INIT
0299 8001            519         SJMP EC_CHECK_INIT_OK
029B                 520     EC_CHECK_INIT:
029B 22              521         RET
029C                 522     EC_CHECK_INIT_OK:
029C E571            523         MOV A, 071h
029E B5704A          524         CJNE A, 070h, EC_INIT
                     525         
                     526         ; Check C key (Reopen) or Current Floor Key
02A1 E561            527         MOV A, 061h
02A3 601F            528         JZ EC_CHECK_REQ
02A5 E560            529         MOV A, 060h
02A7 540F            530         ANL A, #0Fh
02A9 B40C02          531         CJNE A, #0Ch, EC_CHECK_CUR
                     532         ; C pressed -> Reopen
02AC 8003            533         SJMP EC_REOPEN
02AE                 534     EC_CHECK_CUR:
02AE B55613          535         CJNE A, CUR_FLr, EC_CHECK_REQ
                     536         ; Current Floor pressed -> Reopen
02B1                 537     EC_REOPEN:
02B1 757022          538         MOV 070h, #ELEV_ARRIVED
02B4 755705          539         MOV ELEV_TIMER, #05h
02B7 755900          540         MOV ONE_SEC_CNT, #00h
02BA 756400          541         MOV ELEV_DIR, #00h     ; Force Stop for Reopen
02BD 7571FF          542         MOV 071h, #0FFh
02C0 756100          543         MOV 061h, #00h
02C3 22              544         RET
                     545     
02C4                 546     EC_CHECK_REQ:
02C4 120000   F      547         LCALL CHECK_AND_SET_REQUEST
02C7 8000            548         SJMP EC_BLINK_LOGIC
                     549     
02C9                 550     EC_BLINK_LOGIC:
A51 MACRO ASSEMBLER  RUNNINGTASK                                                          01/10/2026 10:26:27 PAGE    10

02C9 E559            551         MOV A, ONE_SEC_CNT
02CB C3              552         CLR C
02CC 9432            553         SUBB A, #50
02CE 5008            554         JNC EC_OFF
                     555         ; ON
02D0 75280C          556         MOV 028h, #12          ; 'C'
02D3 752913          557         MOV 029h, #19          ; 'L'
02D6 8006            558         SJMP EC_TAIL
02D8                 559     EC_OFF:
02D8 752825          560         MOV 028h, #37
02DB 752925          561         MOV 029h, #37
02DE                 562     EC_TAIL:
02DE 752A25          563         MOV 02Ah, #37
02E1 752B25          564         MOV 02Bh, #37
02E4 752C25          565         MOV 02Ch, #37
02E7 752D25          566         MOV 02Dh, #37
02EA 22              567         RET
02EB                 568     EC_INIT:
02EB E570            569         MOV A, 070h
02ED F571            570         MOV 071h, A
                     571         ; MOV P2, #00h           ; Closing: LEDs ON (Removed for LCD compatibility)
                     572         
                     573         ; LCD Update
02EF 120000   F      574         LCALL LCD_CLEAR
02F2 900000   F      575         MOV DPTR, #LCD_MSG_CLOSE
02F5 120000   F      576         LCALL LCD_SHOW_STR
                     577         
02F8 22              578         RET
                     579     
                     580     ; Show open floor helper (Now shows FL + Floor for Idle)
02F9                 581     SHOW_OPEN_FLOOR:
02F9 120000   F      582         LCALL LCD_CLEAR ; Ensure clear
                     583         
                     584         ; Line 1: Welcome
02FC 7480            585         MOV A, #80h
02FE 120000   F      586         LCALL LCD_WR_CMD
0301 900000   F      587         MOV DPTR, #LCD_MSG_WELCOME
0304 120000   F      588         LCALL LCD_SHOW_STR
                     589     
                     590         ; Line 2: FL: [Floor]
0307 74C0            591         MOV A, #0C0h
0309 120000   F      592         LCALL LCD_WR_CMD
030C 900000   F      593         MOV DPTR, #LCD_MSG_FL
030F 120000   F      594         LCALL LCD_SHOW_STR
0312 AE56            595         MOV R6, CUR_FLr
0314 120000   F      596         LCALL LCD_PRINT_FLOOR
                     597         
                     598         ; LED6 Update
0317 75280F          599         MOV 028h, #15          ; 'F'
031A 752913          600         MOV 029h, #19          ; 'L'
031D 752A25          601         MOV 02Ah, #37          ; ' '
0320 752B25          602         MOV 02Bh, #37          ; ' '
0323 E556            603         MOV A, CUR_FLr
0325 20E707          604         JB ACC.7, SOF_NEG
0328 752C25          605         MOV 02Ch, #37          ; ' '
032B 85562D          606         MOV 02Dh, CUR_FLr
032E 22              607         RET
032F                 608     SOF_NEG:
032F 752C24          609         MOV 02Ch, #36          ; '-'
0332 E556            610         MOV A, CUR_FLr
0334 F4              611         CPL A
0335 04              612         INC A
0336 F52D            613         MOV 02Dh, A
0338 22              614         RET
                     615     
                     616     ; ---------------------------------------------------------
A51 MACRO ASSEMBLER  RUNNINGTASK                                                          01/10/2026 10:26:27 PAGE    11

                     617     ; Queue Helper Functions
                     618     ; ---------------------------------------------------------
                     619     
                     620     ; Check if key is floor key (0-9), if so push to queue
                     621     ; Mapping:
                     622     ; Key 0 -> Floor -2 (FEh)
                     623     ; Key 1 -> Floor -1 (FFh)
                     624     ; Key 2 -> Floor 1  (01h)
                     625     ; ...
                     626     ; Key 9 -> Floor 8  (08h)
                     627     ; Key E (14) -> External Up (Push CUR_FLr to EXT_Q)
                     628     ; Key F (15) -> External Down (Push CUR_FLr to EXT_Q)
                     629     ; Helper to map Key (R7) to Floor (R6). CY=1 if valid.
0339                 630     GET_FLOOR_FROM_KEY:
0339 EF              631         MOV A, R7
033A C3              632         CLR C
033B 940A            633         SUBB A, #0Ah
033D 5011            634         JNC GFK_INVALID      ; If Key >= 10, return CY=0
                     635     
                     636         ; Key is 0-9
033F EF              637         MOV A, R7
0340 6006            638         JZ GFK_KEY_0     ; If Key == 0
                     639         
0342 14              640         DEC A            ; A = Key - 1
0343 6007            641         JZ GFK_KEY_1     ; If Key == 1 (A became 0)
                     642         
                     643         ; Key >= 2, Target = Key - 1
0345 FE              644         MOV R6, A
0346 D3              645         SETB C
0347 22              646         RET
                     647     
0348                 648     GFK_KEY_0:
0348 7EFE            649         MOV R6, #0FEh    ; -2
034A D3              650         SETB C
034B 22              651         RET
                     652     
034C                 653     GFK_KEY_1:
034C 7EFF            654         MOV R6, #0FFh    ; -1
034E D3              655         SETB C
034F 22              656         RET
                     657     
0350                 658     GFK_INVALID:
0350 C3              659         CLR C
0351 22              660         RET
                     661     
                     662     ; Helper to print Floor Number (R6) to LCD at current cursor
0352                 663     LCD_PRINT_FLOOR:
0352 EE              664         MOV A, R6
0353 20E70C          665         JB ACC.7, LPF_NEG
                     666         ; Positive
0356 7420            667         MOV A, #' '
0358 120000   F      668         LCALL LCD_WR_DAT
035B EE              669         MOV A, R6
035C 2430            670         ADD A, #'0'
035E 120000   F      671         LCALL LCD_WR_DAT
0361 22              672         RET
0362                 673     LPF_NEG:
0362 742D            674         MOV A, #'-'
0364 120000   F      675         LCALL LCD_WR_DAT
0367 EE              676         MOV A, R6
0368 F4              677         CPL A
0369 04              678         INC A
036A 2430            679         ADD A, #'0'
036C 120000   F      680         LCALL LCD_WR_DAT
036F 22              681         RET
                     682     
A51 MACRO ASSEMBLER  RUNNINGTASK                                                          01/10/2026 10:26:27 PAGE    12

                     683     ; Helper to show Outside Status
                     684     ; R6 = Floor, R5 = Action (0=None, 1=Up, 2=Down)
0370                 685     SHOW_OUTSIDE_STATUS:
0370 7480            686         MOV A, #80h
0372 120000   F      687         LCALL LCD_WR_CMD
                     688         
0375 900000   F      689         MOV DPTR, #LCD_STR_OUT_PREFIX
0378 120000   F      690         LCALL LCD_SHOW_STR
                     691         
037B 120000   F      692         LCALL LCD_PRINT_FLOOR
                     693         
037E 7420            694         MOV A, #' '
0380 120000   F      695         LCALL LCD_WR_DAT
                     696         
0383 ED              697         MOV A, R5
0384 6011            698         JZ SOS_NONE
0386 14              699         DEC A
0387 6007            700         JZ SOS_UP
                     701         ; Down
0389 900000   F      702         MOV DPTR, #LCD_STR_DOWN
038C 120000   F      703         LCALL LCD_SHOW_STR
038F 22              704         RET
0390                 705     SOS_UP:
0390 900000   F      706         MOV DPTR, #LCD_STR_UP
0393 120000   F      707         LCALL LCD_SHOW_STR
0396 22              708         RET
0397                 709     SOS_NONE:
0397 900000   F      710         MOV DPTR, #LCD_STR_EMPTY
039A 120000   F      711         LCALL LCD_SHOW_STR
039D 22              712         RET
                     713     
039E                 714     CHECK_AND_SET_REQUEST:
039E E561            715         MOV A, 061h
03A0 7001            716         JNZ CASR_HAS_KEY
03A2 22              717         RET
                     718     
03A3                 719     CASR_HAS_KEY:
                     720         ; Check Long Press A (08Ah)
03A3 E560            721         MOV A, 060h
03A5 B48A0A          722         CJNE A, #08Ah, CASR_NORMAL
03A8 757002          723         MOV 070h, #PASS_ST
03AB 756D01          724         MOV PASS_NEXT_ST, #OPT_ST
03AE 756100          725         MOV 061h, #00h
03B1 22              726         RET
                     727     
03B2                 728     CASR_NORMAL:
03B2 540F            729         ANL A, #0Fh
03B4 FF              730         MOV R7, A
                     731         
                     732         ; Check for 'A' (Mode Switch)
03B5 BF0A20          733         CJNE R7, #0Ah, CASR_CHK_MODE
                     734         
                     735         ; Toggle Mode
03B8 E565            736         MOV A, INPUT_MODE
03BA 6401            737         XRL A, #01h
03BC F565            738         MOV INPUT_MODE, A
                     739         
                     740         ; Update LCD
03BE E565            741         MOV A, INPUT_MODE
03C0 6009            742         JZ CASR_SHOW_INSIDE
                     743         
                     744         ; Show Outside (Default Select)
03C2 AE66            745         MOV R6, OUT_SEL_VAL
03C4 7D00            746         MOV R5, #00h
03C6 120000   F      747         LCALL SHOW_OUTSIDE_STATUS
03C9 805A            748         SJMP CASR_CONSUME
A51 MACRO ASSEMBLER  RUNNINGTASK                                                          01/10/2026 10:26:27 PAGE    13

                     749         
03CB                 750     CASR_SHOW_INSIDE:
03CB 7480            751         MOV A, #80h
03CD 120000   F      752         LCALL LCD_WR_CMD
03D0 900000   F      753         MOV DPTR, #LCD_MSG_INSIDE
03D3 120000   F      754         LCALL LCD_SHOW_STR
03D6 804D            755         SJMP CASR_CONSUME
                     756     
03D8                 757     CASR_CHK_MODE:
03D8 E565            758         MOV A, INPUT_MODE
03DA 7014            759         JNZ CASR_OUTSIDE_MODE
                     760         
                     761         ; --- INSIDE MODE ---
                     762         ; Check 0-9
03DC 120000   F      763         LCALL GET_FLOOR_FROM_KEY
03DF 5005            764         JNC CASR_IN_CHK_OTHER
                     765         ; Valid Floor in R6 -> Set Internal Bitmap
03E1 120000   F      766         LCALL SET_INT_REQUEST
03E4 803F            767         SJMP CASR_CONSUME
                     768         
03E6                 769     CASR_IN_CHK_OTHER:
                     770         ; Check E/F -> Ignore
03E6 BF0E02          771         CJNE R7, #0Eh, CASR_IN_CHK_F
03E9 803A            772         SJMP CASR_CONSUME
03EB                 773     CASR_IN_CHK_F:
03EB BF0F3A          774         CJNE R7, #0Fh, CASR_RET
03EE 8035            775         SJMP CASR_CONSUME
                     776     
                     777         ; --- OUTSIDE MODE ---
03F0                 778     CASR_OUTSIDE_MODE:
                     779         ; Check 0-9
03F0 120000   F      780         LCALL GET_FLOOR_FROM_KEY
03F3 5009            781         JNC CASR_OUT_CHK_OTHER
                     782         ; Valid Floor -> Store selection
03F5 8E66            783         MOV OUT_SEL_VAL, R6
                     784         ; Update Display
03F7 7D00            785         MOV R5, #00h
03F9 120000   F      786         LCALL SHOW_OUTSIDE_STATUS
03FC 8027            787         SJMP CASR_CONSUME
                     788     
03FE                 789     CASR_OUT_CHK_OTHER:
                     790         ; Check E/F -> Set External Bitmap
03FE BF0E09          791         CJNE R7, #0Eh, CASR_OUT_CHK_F
                     792         ; Key E (Up)
0401 AE66            793         MOV R6, OUT_SEL_VAL
0403 120000   F      794         LCALL SET_EXT_UP_REQUEST
0406 7D01            795         MOV R5, #01h
0408 800A            796         SJMP CASR_OUT_SHOW
040A                 797     CASR_OUT_CHK_F:
040A BF0F0E          798         CJNE R7, #0Fh, CASR_OUT_CHK_CD
                     799         ; Key F (Down)
040D AE66            800         MOV R6, OUT_SEL_VAL
040F 120000   F      801         LCALL SET_EXT_DN_REQUEST
0412 7D02            802         MOV R5, #02h
                     803         
0414                 804     CASR_OUT_SHOW:
0414 AE66            805         MOV R6, OUT_SEL_VAL
0416 120000   F      806         LCALL SHOW_OUTSIDE_STATUS
0419 800A            807         SJMP CASR_CONSUME
                     808     
041B                 809     CASR_OUT_CHK_CD:
                     810         ; Check C/D -> Consume (Ignore)
041B BF0C02          811         CJNE R7, #0Ch, CASR_OUT_CHK_D
041E 8005            812         SJMP CASR_CONSUME
0420                 813     CASR_OUT_CHK_D:
0420 BF0D05          814         CJNE R7, #0Dh, CASR_RET
A51 MACRO ASSEMBLER  RUNNINGTASK                                                          01/10/2026 10:26:27 PAGE    14

0423 8000            815         SJMP CASR_CONSUME
                     816     
0425                 817     CASR_CONSUME:
0425 756100          818         MOV 061h, #00h
0428                 819     CASR_RET:
0428 22              820         RET
                     821     
                     822     ; ---------------------------------------------------------
                     823     ; Bitmap Helper Functions
                     824     ; ---------------------------------------------------------
                     825     
                     826     ; Convert Floor (R6) to Bit Index (R4)
                     827     ; Floor -2 -> Index 0, Floor -1 -> Index 1
                     828     ; Floor 1 -> Index 2, Floor 2 -> Index 3, ... Floor 8 -> Index 10
                     829     ; Returns: R4 = bit index (0-10)
0429                 830     FLOOR_TO_INDEX:
0429 EE              831         MOV A, R6
042A 20E703          832         JB ACC.7, FTI_NEG
                     833         ; Positive floor (1-8) -> Index = Floor + 1
042D 04              834         INC A
042E FC              835         MOV R4, A
042F 22              836         RET
0430                 837     FTI_NEG:
                     838         ; Negative floor: -2 (FEh) -> 0, -1 (FFh) -> 1
                     839         ; Index = Floor + 2
0430 2402            840         ADD A, #02h
0432 FC              841         MOV R4, A
0433 22              842         RET
                     843     
                     844     ; Convert Bit Index (R4) to Floor (R6)
0434                 845     INDEX_TO_FLOOR:
0434 EC              846         MOV A, R4
0435 B40003          847         CJNE A, #00h, ITF_CHK1
0438 7EFE            848         MOV R6, #0FEh   ; -2
043A 22              849         RET
043B                 850     ITF_CHK1:
043B B40103          851         CJNE A, #01h, ITF_POS
043E 7EFF            852         MOV R6, #0FFh   ; -1
0440 22              853         RET
0441                 854     ITF_POS:
                     855         ; Index >= 2: Floor = Index - 1
0441 14              856         DEC A
0442 FE              857         MOV R6, A
0443 22              858         RET
                     859     
                     860     ; Set bit for floor R6 in Internal Request bitmap
0444                 861     SET_INT_REQUEST:
0444 120000   F      862         LCALL FLOOR_TO_INDEX
                     863         ; R4 = bit index
0447 EC              864         MOV A, R4
0448 C3              865         CLR C
0449 9408            866         SUBB A, #08h
044B 5009            867         JNC SIR_HI
                     868         ; Low byte (index 0-7)
044D 120000   F      869         LCALL GET_BIT_MASK   ; R3 = mask for bit R4
0450 E55C            870         MOV A, INT_REQ_LO
0452 4B              871         ORL A, R3
0453 F55C            872         MOV INT_REQ_LO, A
0455 22              873         RET
0456                 874     SIR_HI:
                     875         ; High byte (index 8-10)
0456 EC              876         MOV A, R4
0457 C3              877         CLR C
0458 9408            878         SUBB A, #08h
045A FC              879         MOV R4, A
045B 120000   F      880         LCALL GET_BIT_MASK
A51 MACRO ASSEMBLER  RUNNINGTASK                                                          01/10/2026 10:26:27 PAGE    15

045E E55D            881         MOV A, INT_REQ_HI
0460 4B              882         ORL A, R3
0461 F55D            883         MOV INT_REQ_HI, A
0463 22              884         RET
                     885     
                     886     ; Set bit for floor R6 in External UP Request bitmap
0464                 887     SET_EXT_UP_REQUEST:
0464 120000   F      888         LCALL FLOOR_TO_INDEX
0467 EC              889         MOV A, R4
0468 C3              890         CLR C
0469 9408            891         SUBB A, #08h
046B 5009            892         JNC SEUR_HI
046D 120000   F      893         LCALL GET_BIT_MASK
0470 E55E            894         MOV A, EXT_UP_LO
0472 4B              895         ORL A, R3
0473 F55E            896         MOV EXT_UP_LO, A
0475 22              897         RET
0476                 898     SEUR_HI:
0476 EC              899         MOV A, R4
0477 C3              900         CLR C
0478 9408            901         SUBB A, #08h
047A FC              902         MOV R4, A
047B 120000   F      903         LCALL GET_BIT_MASK
047E E55F            904         MOV A, EXT_UP_HI
0480 4B              905         ORL A, R3
0481 F55F            906         MOV EXT_UP_HI, A
0483 22              907         RET
                     908     
                     909     ; Set bit for floor R6 in External DOWN Request bitmap
0484                 910     SET_EXT_DN_REQUEST:
0484 120000   F      911         LCALL FLOOR_TO_INDEX
0487 EC              912         MOV A, R4
0488 C3              913         CLR C
0489 9408            914         SUBB A, #08h
048B 5009            915         JNC SEDR_HI
048D 120000   F      916         LCALL GET_BIT_MASK
0490 E562            917         MOV A, EXT_DN_LO
0492 4B              918         ORL A, R3
0493 F562            919         MOV EXT_DN_LO, A
0495 22              920         RET
0496                 921     SEDR_HI:
0496 EC              922         MOV A, R4
0497 C3              923         CLR C
0498 9408            924         SUBB A, #08h
049A FC              925         MOV R4, A
049B 120000   F      926         LCALL GET_BIT_MASK
049E E563            927         MOV A, EXT_DN_HI
04A0 4B              928         ORL A, R3
04A1 F563            929         MOV EXT_DN_HI, A
04A3 22              930         RET
                     931     
                     932     ; Get bit mask for bit index R4 (0-7), return in R3
04A4                 933     GET_BIT_MASK:
04A4 EC              934         MOV A, R4
04A5 900000   F      935         MOV DPTR, #BIT_MASK_TBL
04A8 93              936         MOVC A, @A+DPTR
04A9 FB              937         MOV R3, A
04AA 22              938         RET
                     939     
04AB                 940     BIT_MASK_TBL:
04AB 01020408        941         DB 001h, 002h, 004h, 008h, 010h, 020h, 040h, 080h
04AF 10204080                
                     942     
                     943     ; Clear request for floor R6 from all bitmaps
04B3                 944     CLEAR_FLOOR_REQUEST:
04B3 120000   F      945         LCALL FLOOR_TO_INDEX
A51 MACRO ASSEMBLER  RUNNINGTASK                                                          01/10/2026 10:26:27 PAGE    16

04B6 EC              946         MOV A, R4
04B7 C3              947         CLR C
04B8 9408            948         SUBB A, #08h
04BA 5016            949         JNC CFR_HI
                     950         ; Low byte
04BC 120000   F      951         LCALL GET_BIT_MASK
04BF EB              952         MOV A, R3
04C0 F4              953         CPL A           ; Invert mask
04C1 FB              954         MOV R3, A
04C2 E55C            955         MOV A, INT_REQ_LO
04C4 5B              956         ANL A, R3
04C5 F55C            957         MOV INT_REQ_LO, A
04C7 E55E            958         MOV A, EXT_UP_LO
04C9 5B              959         ANL A, R3
04CA F55E            960         MOV EXT_UP_LO, A
04CC E562            961         MOV A, EXT_DN_LO
04CE 5B              962         ANL A, R3
04CF F562            963         MOV EXT_DN_LO, A
04D1 22              964         RET
04D2                 965     CFR_HI:
04D2 EC              966         MOV A, R4
04D3 C3              967         CLR C
04D4 9408            968         SUBB A, #08h
04D6 FC              969         MOV R4, A
04D7 120000   F      970         LCALL GET_BIT_MASK
04DA EB              971         MOV A, R3
04DB F4              972         CPL A
04DC FB              973         MOV R3, A
04DD E55D            974         MOV A, INT_REQ_HI
04DF 5B              975         ANL A, R3
04E0 F55D            976         MOV INT_REQ_HI, A
04E2 E55F            977         MOV A, EXT_UP_HI
04E4 5B              978         ANL A, R3
04E5 F55F            979         MOV EXT_UP_HI, A
04E7 E563            980         MOV A, EXT_DN_HI
04E9 5B              981         ANL A, R3
04EA F563            982         MOV EXT_DN_HI, A
04EC 22              983         RET
                     984     
                     985     ; Check if there's any request at floor R6
                     986     ; Returns CY=1 if request exists
04ED                 987     CHECK_FLOOR_REQUEST:
04ED 120000   F      988         LCALL FLOOR_TO_INDEX
04F0 EC              989         MOV A, R4
04F1 C3              990         CLR C
04F2 9408            991         SUBB A, #08h
04F4 5020            992         JNC CHKFR_HI
                     993         
                     994         ; Low Byte
04F6 120000   F      995         LCALL GET_BIT_MASK
                     996         ; Check Internal
04F9 E55C            997         MOV A, INT_REQ_LO
04FB 5B              998         ANL A, R3
04FC 703F            999         JNZ CHKFR_FOUND
                    1000         
                    1001         ; Check External - Dir dependent
04FE E564           1002         MOV A, ELEV_DIR
0500 B40202         1003         CJNE A, #02h, CFR_LO_CHK_UP  ; If Dir != 2 (0 or 1), check UP
0503 800A           1004         SJMP CFR_LO_CHK_DN           ; If Dir == 2, check DOWN only
                    1005         
0505                1006     CFR_LO_CHK_UP:
0505 E55E           1007         MOV A, EXT_UP_LO
0507 5B             1008         ANL A, R3
0508 7033           1009         JNZ CHKFR_FOUND
                    1010         
                    1011         ; If Dir=1 (Up), we are done (don't check down)
A51 MACRO ASSEMBLER  RUNNINGTASK                                                          01/10/2026 10:26:27 PAGE    17

050A E564           1012         MOV A, ELEV_DIR
050C B4002C         1013         CJNE A, #00h, CHKFR_NOTFOUND ; If Dir != 0 (i.e. 1), Ret Not Found
                    1014         
                    1015         ; If Dir=0, Fall through to check DOWN
                    1016         
050F                1017     CFR_LO_CHK_DN:
050F E562           1018         MOV A, EXT_DN_LO
0511 5B             1019         ANL A, R3
0512 7029           1020         JNZ CHKFR_FOUND
0514 8025           1021         SJMP CHKFR_NOTFOUND
                    1022         
0516                1023     CHKFR_HI:
                    1024         ; High Byte adjustment logic
0516 EC             1025         MOV A, R4
0517 C3             1026         CLR C
0518 9408           1027         SUBB A, #08h
051A FC             1028         MOV R4, A
051B 120000   F     1029         LCALL GET_BIT_MASK
                    1030         
                    1031         ; Check Internal
051E E55D           1032         MOV A, INT_REQ_HI
0520 5B             1033         ANL A, R3
0521 701A           1034         JNZ CHKFR_FOUND
                    1035         
                    1036         ; Check External
0523 E564           1037         MOV A, ELEV_DIR
0525 B40202         1038         CJNE A, #02h, CFR_HI_CHK_UP
0528 800A           1039         SJMP CFR_HI_CHK_DN
                    1040         
052A                1041     CFR_HI_CHK_UP:
052A E55F           1042         MOV A, EXT_UP_HI
052C 5B             1043         ANL A, R3
052D 700E           1044         JNZ CHKFR_FOUND
                    1045         
052F E564           1046         MOV A, ELEV_DIR
0531 B40007         1047         CJNE A, #00h, CHKFR_NOTFOUND
                    1048         
0534                1049     CFR_HI_CHK_DN:
0534 E563           1050         MOV A, EXT_DN_HI
0536 5B             1051         ANL A, R3
0537 7004           1052         JNZ CHKFR_FOUND
0539 8000           1053         SJMP CHKFR_NOTFOUND
                    1054         
053B                1055     CHKFR_NOTFOUND:
053B C3             1056         CLR C
053C 22             1057         RET
053D                1058     CHKFR_FOUND:
053D D3             1059         SETB C
053E 22             1060         RET
                    1061     
                    1062     ; ---------------------------------------------------------
                    1063     ; SCAN Algorithm: Find next target floor
                    1064     ; Returns: R6 = target floor, CY=1 if found, CY=0 if no request
                    1065     ; ---------------------------------------------------------
053F                1066     SCAN_FIND_NEXT_TARGET:
                    1067         ; First check if any request exists
053F E55C           1068         MOV A, INT_REQ_LO
0541 455D           1069         ORL A, INT_REQ_HI
0543 455E           1070         ORL A, EXT_UP_LO
0545 455F           1071         ORL A, EXT_UP_HI
0547 4562           1072         ORL A, EXT_DN_LO
0549 4563           1073         ORL A, EXT_DN_HI
054B 7002           1074         JNZ SCAN_HAS_REQ
054D C3             1075         CLR C
054E 22             1076         RET
                    1077     
A51 MACRO ASSEMBLER  RUNNINGTASK                                                          01/10/2026 10:26:27 PAGE    18

054F                1078     SCAN_HAS_REQ:
                    1079         ; Get current floor index
054F AE56           1080         MOV R6, CUR_FLr
0551 120000   F     1081         LCALL FLOOR_TO_INDEX
0554 EC             1082         MOV A, R4
0555 FD             1083         MOV R5, A         ; R5 = current index
                    1084         
                    1085         ; R2 = tried flags: bit0=tried up, bit1=tried down
0556 7A00           1086         MOV R2, #00h
                    1087         
                    1088         ; Check direction: if stopped (0), default to up (1)
0558 E564           1089         MOV A, ELEV_DIR
055A 6005           1090         JZ SCAN_DEFAULT_UP
055C B40205         1091         CJNE A, #02h, SCAN_TRY_UP
055F 8038           1092         SJMP SCAN_TRY_DOWN
                    1093         
0561                1094     SCAN_DEFAULT_UP:
0561 756401         1095         MOV ELEV_DIR, #01h   ; Default direction up
                    1096     
0564                1097     SCAN_TRY_UP:
                    1098         ; Mark that we tried up
0564 EA             1099         MOV A, R2
0565 4401           1100         ORL A, #01h
0567 FA             1101         MOV R2, A
                    1102         
                    1103         ; Try to find request above or at current floor
                    1104         ; 【第一轮：严格扫描】找内选和外呼上
0568 ED             1105         MOV A, R5
0569 FC             1106         MOV R4, A         ; Start from current index
056A                1107     SCAN_UP_LOOP_STRICT:
                    1108         ; Check if there's request at R4
056A 120000   F     1109         LCALL INDEX_TO_FLOOR
056D EE             1110         MOV A, R6
056E B55602         1111         CJNE A, CUR_FLr, SUS_CHECK
0571 8005           1112         SJMP SUS_NEXT  ; Skip current floor
0573                1113     SUS_CHECK:
0573 120000   F     1114         LCALL SCAN_CHECK_UP_STRICT ; <--- 调用严格检查
0576 4058           1115         JC SCAN_FOUND
0578                1116     SUS_NEXT:
0578 0C             1117         INC R4
0579 EC             1118         MOV A, R4
057A B40BED         1119         CJNE A, #11, SCAN_UP_LOOP_STRICT
                    1120         
                    1121         ; 【第二轮：宽松扫描】由远及近扫描 (从顶层向下扫到当前层)
057D 7C0A           1122         MOV R4, #0Ah          ; Start from Index 10 (Floor 8)
057F                1123     SCAN_UP_LOOP_LOOSE:
057F EC             1124         MOV A, R4
0580 C3             1125         CLR C
0581 9D             1126         SUBB A, R5            ; Check if R4 <= Current Index (R5)
0582 400D           1127         JC SUL_DONE           ; If R4 < Current, Stop
0584 600B           1128         JZ SUL_DONE           ; If R4 == Current, Stop
                    1129     
0586 120000   F     1130         LCALL INDEX_TO_FLOOR
0589 120000   F     1131         LCALL SCAN_CHECK_UP_LOOSE ; Check EXT_DN
058C 4042           1132         JC SCAN_FOUND
                    1133     
058E 1C             1134         DEC R4
058F 80EE           1135         SJMP SCAN_UP_LOOP_LOOSE
                    1136     
0591                1137     SUL_DONE:
                    1138     
                    1139         ; No request above, check if we already tried down
0591 EA             1140         MOV A, R2
0592 5402           1141         ANL A, #02h
0594 7035           1142         JNZ SCAN_FAIL       ; Already tried down
                    1143         
A51 MACRO ASSEMBLER  RUNNINGTASK                                                          01/10/2026 10:26:27 PAGE    19

                    1144         ; Switch to down
0596 756402         1145         MOV ELEV_DIR, #02h
                    1146         ; Fall through to SCAN_TRY_DOWN
                    1147     
0599                1148     SCAN_TRY_DOWN:
                    1149         ; Mark that we tried down
0599 EA             1150         MOV A, R2
059A 4402           1151         ORL A, #02h
059C FA             1152         MOV R2, A
                    1153         ; 【第一轮：严格扫描】找内选和外呼下
                    1154         ; Try to find request below current floor
059D ED             1155         MOV A, R5
059E FC             1156         MOV R4, A         ; Start from current index
059F                1157     SCAN_DN_LOOP_STRICT:
059F EC             1158         MOV A, R4
05A0 600B           1159         JZ SCAN_DN_STRICT_DONE   ; Reached bottom
05A2 1C             1160         DEC R4
05A3 120000   F     1161         LCALL INDEX_TO_FLOOR
05A6 120000   F     1162         LCALL SCAN_CHECK_DN_STRICT ; <--- 调用严格检查
05A9 4025           1163         JC SCAN_FOUND
05AB 80F2           1164         SJMP SCAN_DN_LOOP_STRICT
05AD                1165     SCAN_DN_STRICT_DONE:
                    1166      ; 【第二轮：宽松扫描】由远及近扫描 (从底层向上扫到当前层)
05AD 7C00           1167         MOV R4, #00h          ; Start from Index 0 (Floor -2)
05AF                1168     SCAN_DN_LOOP_LOOSE:
05AF ED             1169         MOV A, R5
05B0 C3             1170         CLR C
05B1 9C             1171         SUBB A, R4            ; Check if Current <= R4
05B2 400D           1172         JC SCAN_DN_LOOSE_DONE ; If Current < R4 (Should not happen if logic correct), Stop
05B4 600B           1173         JZ SCAN_DN_LOOSE_DONE ; If Current == R4, Stop
                    1174     
05B6 120000   F     1175         LCALL INDEX_TO_FLOOR
05B9 120000   F     1176         LCALL SCAN_CHECK_DN_LOOSE  ; Check EXT_UP
05BC 4012           1177         JC SCAN_FOUND
                    1178         
05BE 0C             1179         INC R4
05BF 80EE           1180         SJMP SCAN_DN_LOOP_LOOSE
                    1181     
05C1                1182     SCAN_DN_LOOSE_DONE:
                    1183         ; No request below, check if we already tried up
05C1 EA             1184         MOV A, R2
05C2 5401           1185         ANL A, #01h
05C4 7005           1186         JNZ SCAN_FAIL       ; Already tried up
                    1187         
                    1188         ; Switch to up
05C6 756401         1189         MOV ELEV_DIR, #01h
05C9 8099           1190         SJMP SCAN_TRY_UP
                    1191     
05CB                1192     SCAN_FAIL:
05CB 756400         1193         MOV ELEV_DIR, #00h   ; Reset direction
05CE C3             1194         CLR C
05CF 22             1195         RET
                    1196     
05D0                1197     SCAN_FOUND:
                    1198         ; R6 has the target floor
05D0 D3             1199         SETB C
05D1 22             1200         RET
                    1201     
                    1202     ; Check if floor R6 has request for UP direction
                    1203     ; (Internal or External UP)
05D2                1204     SCAN_CHECK_UP_REQUEST:
05D2 C004           1205         PUSH 04h
05D4 120000   F     1206         LCALL FLOOR_TO_INDEX
05D7 EC             1207         MOV A, R4
05D8 C3             1208         CLR C
05D9 9408           1209         SUBB A, #08h
A51 MACRO ASSEMBLER  RUNNINGTASK                                                          01/10/2026 10:26:27 PAGE    20

05DB 500F           1210         JNC SCUR_HI
05DD 120000   F     1211         LCALL GET_BIT_MASK
                    1212         ; Always check Internal
05E0 E55C           1213         MOV A, INT_REQ_LO
05E2 5B             1214         ANL A, R3
05E3 701D           1215         JNZ SCUR_FOUND
                    1216         ; Also check External UP
05E5 E55E           1217         MOV A, EXT_UP_LO
05E7 5B             1218         ANL A, R3
05E8 7018           1219         JNZ SCUR_FOUND
05EA 8012           1220         SJMP SCUR_NOTFOUND
05EC                1221     SCUR_HI:
05EC EC             1222         MOV A, R4
05ED C3             1223         CLR C
05EE 9408           1224         SUBB A, #08h
05F0 FC             1225         MOV R4, A
05F1 120000   F     1226         LCALL GET_BIT_MASK
05F4 E55D           1227         MOV A, INT_REQ_HI
05F6 5B             1228         ANL A, R3
05F7 7009           1229         JNZ SCUR_FOUND
05F9 E55F           1230         MOV A, EXT_UP_HI
05FB 5B             1231         ANL A, R3
05FC 7004           1232         JNZ SCUR_FOUND
                    1233     
05FE                1234     SCUR_NOTFOUND:
05FE D004           1235         POP 04h
0600 C3             1236         CLR C
0601 22             1237         RET
0602                1238     SCUR_FOUND:
0602 D004           1239         POP 04h
0604 D3             1240         SETB C
0605 22             1241         RET
                    1242     
                    1243     ; Check if floor R6 has request for DOWN direction
                    1244     ; (Internal or External DOWN)
0606                1245     SCAN_CHECK_DN_REQUEST:
0606 C004           1246         PUSH 04h
0608 120000   F     1247         LCALL FLOOR_TO_INDEX
060B EC             1248         MOV A, R4
060C C3             1249         CLR C
060D 9408           1250         SUBB A, #08h
060F 500F           1251         JNC SCDR_HI
0611 120000   F     1252         LCALL GET_BIT_MASK
                    1253         ; Always check Internal
0614 E55C           1254         MOV A, INT_REQ_LO
0616 5B             1255         ANL A, R3
0617 701D           1256         JNZ SCDR_FOUND
                    1257         ; Also check External DOWN
0619 E562           1258         MOV A, EXT_DN_LO
061B 5B             1259         ANL A, R3
061C 7018           1260         JNZ SCDR_FOUND
061E 8012           1261         SJMP SCDR_NOTFOUND
0620                1262     SCDR_HI:
0620 EC             1263         MOV A, R4
0621 C3             1264         CLR C
0622 9408           1265         SUBB A, #08h
0624 FC             1266         MOV R4, A
0625 120000   F     1267         LCALL GET_BIT_MASK
0628 E55D           1268         MOV A, INT_REQ_HI
062A 5B             1269         ANL A, R3
062B 7009           1270         JNZ SCDR_FOUND
062D E563           1271         MOV A, EXT_DN_HI
062F 5B             1272         ANL A, R3
0630 7004           1273         JNZ SCDR_FOUND
                    1274     
0632                1275     SCDR_NOTFOUND:
A51 MACRO ASSEMBLER  RUNNINGTASK                                                          01/10/2026 10:26:27 PAGE    21

0632 D004           1276         POP 04h
0634 C3             1277         CLR C
0635 22             1278         RET
0636                1279     SCDR_FOUND:
0636 D004           1280         POP 04h
0638 D3             1281         SETB C
0639 22             1282         RET
                    1283     ; 修改上面的逻辑，原函数保留没动，新增两个宽松检查函数
                    1284     ; ------------------------------------------
                    1285     ; 1. 严格检查：只查 内选 + 同向 (用于第一轮扫描)
                    1286     ; ------------------------------------------
                    1287     
                    1288     ; 向下严查：查 INT + EXT_DN
063A                1289     SCAN_CHECK_DN_STRICT:
063A C004           1290         PUSH 04h
063C 120000   F     1291         LCALL FLOOR_TO_INDEX
063F EC             1292         MOV A, R4
0640 C3             1293         CLR C
0641 9408           1294         SUBB A, #08h
0643 500F           1295         JNC SCDS_HI
                    1296         ; Low Byte
0645 120000   F     1297         LCALL GET_BIT_MASK
0648 E55C           1298         MOV A, INT_REQ_LO
064A 5B             1299         ANL A, R3
064B 7019           1300         JNZ SCDS_FOUND
064D E562           1301         MOV A, EXT_DN_LO
064F 5B             1302         ANL A, R3
0650 7014           1303         JNZ SCDS_FOUND
0652 800E           1304         SJMP SCDS_NOTFOUND    
0654                1305     SCDS_HI:
                    1306         ; High Byte
0654 FC             1307         MOV R4, A        
0655 120000   F     1308         LCALL GET_BIT_MASK
0658 E55D           1309         MOV A, INT_REQ_HI
065A 5B             1310         ANL A, R3
065B 7009           1311         JNZ SCDS_FOUND
065D E563           1312         MOV A, EXT_DN_HI
065F 5B             1313         ANL A, R3
0660 7004           1314         JNZ SCDS_FOUND  
0662                1315     SCDS_NOTFOUND:
0662 D004           1316         POP 04h
0664 C3             1317         CLR C
0665 22             1318         RET
0666                1319     SCDS_FOUND:
0666 D004           1320         POP 04h
0668 D3             1321         SETB C
0669 22             1322         RET
                    1323     
                    1324     ; 向上严查：查 INT + EXT_UP
066A                1325     SCAN_CHECK_UP_STRICT:
066A C004           1326         PUSH 04h
066C 120000   F     1327         LCALL FLOOR_TO_INDEX
066F EC             1328         MOV A, R4
0670 C3             1329         CLR C
0671 9408           1330         SUBB A, #08h
0673 500F           1331         JNC SCUS_HI
                    1332         ; Low Byte
0675 120000   F     1333         LCALL GET_BIT_MASK
0678 E55C           1334         MOV A, INT_REQ_LO
067A 5B             1335         ANL A, R3
067B 7019           1336         JNZ SCUS_FOUND
067D E55E           1337         MOV A, EXT_UP_LO
067F 5B             1338         ANL A, R3
0680 7014           1339         JNZ SCUS_FOUND
0682 800E           1340         SJMP SCUS_NOTFOUND
0684                1341     SCUS_HI:
A51 MACRO ASSEMBLER  RUNNINGTASK                                                          01/10/2026 10:26:27 PAGE    22

                    1342         ; High Byte
0684 FC             1343         MOV R4, A 
0685 120000   F     1344         LCALL GET_BIT_MASK
0688 E55D           1345         MOV A, INT_REQ_HI
068A 5B             1346         ANL A, R3
068B 7009           1347         JNZ SCUS_FOUND
068D E55F           1348         MOV A, EXT_UP_HI
068F 5B             1349         ANL A, R3
0690 7004           1350         JNZ SCUS_FOUND
0692                1351     SCUS_NOTFOUND:
0692 D004           1352         POP 04h
0694 C3             1353         CLR C
0695 22             1354         RET
0696                1355     SCUS_FOUND:
0696 D004           1356         POP 04h
0698 D3             1357         SETB C
0699 22             1358         RET
                    1359     ; ------------------------------------------
                    1360     ; 2. 宽松检查：只查 反向 (用于第二轮扫描)
                    1361     ; ------------------------------------------
                    1362     ; 向下松查：只查 EXT_UP
069A                1363     SCAN_CHECK_DN_LOOSE:
069A C004           1364         PUSH 04h
069C 120000   F     1365         LCALL FLOOR_TO_INDEX
069F EC             1366         MOV A, R4
06A0 C3             1367         CLR C
06A1 9408           1368         SUBB A, #08h
06A3 500A           1369         JNC SCDL_HI
                    1370         ; Low Byte
06A5 120000   F     1371         LCALL GET_BIT_MASK
06A8 E55E           1372         MOV A, EXT_UP_LO
06AA 5B             1373         ANL A, R3
06AB 700F           1374         JNZ SCDL_FOUND
06AD 8009           1375         SJMP SCDL_NOTFOUND
06AF                1376     SCDL_HI:
                    1377         ; High Byte
06AF FC             1378         MOV R4, A
06B0 120000   F     1379         LCALL GET_BIT_MASK
06B3 E55F           1380         MOV A, EXT_UP_HI
06B5 5B             1381         ANL A, R3
06B6 7004           1382         JNZ SCDL_FOUND 
06B8                1383     SCDL_NOTFOUND:
06B8 D004           1384         POP 04h
06BA C3             1385         CLR C
06BB 22             1386         RET
06BC                1387     SCDL_FOUND:
06BC D004           1388         POP 04h
06BE D3             1389         SETB C
06BF 22             1390         RET
                    1391     
                    1392     ; 向上松查：只查 EXT_DN
06C0                1393     SCAN_CHECK_UP_LOOSE:
06C0 C004           1394         PUSH 04h
06C2 120000   F     1395         LCALL FLOOR_TO_INDEX
06C5 EC             1396         MOV A, R4
06C6 C3             1397         CLR C
06C7 9408           1398         SUBB A, #08h
06C9 500A           1399         JNC SCUL_HI 
                    1400         ; Low Byte
06CB 120000   F     1401         LCALL GET_BIT_MASK
06CE E562           1402         MOV A, EXT_DN_LO
06D0 5B             1403         ANL A, R3
06D1 700F           1404         JNZ SCUL_FOUND
06D3 8009           1405         SJMP SCUL_NOTFOUND
06D5                1406     SCUL_HI:
                    1407         ; High Byte
A51 MACRO ASSEMBLER  RUNNINGTASK                                                          01/10/2026 10:26:27 PAGE    23

06D5 FC             1408         MOV R4, A
06D6 120000   F     1409         LCALL GET_BIT_MASK
06D9 E563           1410         MOV A, EXT_DN_HI
06DB 5B             1411         ANL A, R3
06DC 7004           1412         JNZ SCUL_FOUND
06DE                1413     SCUL_NOTFOUND:
06DE D004           1414         POP 04h
06E0 C3             1415         CLR C
06E1 22             1416         RET
06E2                1417     SCUL_FOUND:
06E2 D004           1418         POP 04h
06E4 D3             1419         SETB C
06E5 22             1420         RET
                    1421     
                    1422     ; ---------------------------------------------------------
                    1423     ; Display Helpers
                    1424     ; ---------------------------------------------------------
                    1425     
                    1426     ; Update Current Floor at 02Ah/02Bh
06E6                1427     UPDATE_CUR_DISPLAY:
06E6 E556           1428         MOV A, CUR_FLr
06E8 20E707         1429         JB ACC.7, UCD_NEG
06EB 752A25         1430         MOV 02Ah, #37      ; Space
06EE 85562B         1431         MOV 02Bh, CUR_FLr
06F1 22             1432         RET
06F2                1433     UCD_NEG:
06F2 752A24         1434         MOV 02Ah, #36      ; '-'
06F5 E556           1435         MOV A, CUR_FLr
06F7 F4             1436         CPL A
06F8 04             1437         INC A
06F9 F52B           1438         MOV 02Bh, A
06FB 22             1439         RET
                    1440     
                    1441     ; Update Target Floor at 02Ch/02Dh
06FC                1442     UPDATE_TGT_DISPLAY:
06FC E558           1443         MOV A, ELEV_TARGET
06FE 20E707         1444         JB ACC.7, UTD_NEG
0701 752C25         1445         MOV 02Ch, #37      ; Space
0704 85582D         1446         MOV 02Dh, ELEV_TARGET
0707 22             1447         RET
0708                1448     UTD_NEG:
0708 752C24         1449         MOV 02Ch, #36      ; '-'
070B E558           1450         MOV A, ELEV_TARGET
070D F4             1451         CPL A
070E 04             1452         INC A
070F F52D           1453         MOV 02Dh, A
0711 22             1454         RET
                    1455     
                    1456     END
A51 MACRO ASSEMBLER  RUNNINGTASK                                                          01/10/2026 10:26:27 PAGE    24

SYMBOL TABLE LISTING
------ ----- -------


N A M E                T Y P E  V A L U E   ATTRIBUTES

ACC . . . . . . . . .  D ADDR   00E0H   A   
ARR_NEG . . . . . . .  C ADDR   0267H   R   SEG=RUNNING
BITMASK_TABLE . . . .  C ADDR   0026H   R   SEG=RUNNING
BIT_MASK_TBL. . . . .  C ADDR   04ABH   R   SEG=RUNNING
BLINK_TIMER . . . . .  N NUMB   005AH   A   
BLINK_TOGGLE. . . . .  N NUMB   005BH   A   
CASR_CHK_MODE . . . .  C ADDR   03D8H   R   SEG=RUNNING
CASR_CONSUME. . . . .  C ADDR   0425H   R   SEG=RUNNING
CASR_HAS_KEY. . . . .  C ADDR   03A3H   R   SEG=RUNNING
CASR_IN_CHK_F . . . .  C ADDR   03EBH   R   SEG=RUNNING
CASR_IN_CHK_OTHER . .  C ADDR   03E6H   R   SEG=RUNNING
CASR_NORMAL . . . . .  C ADDR   03B2H   R   SEG=RUNNING
CASR_OUTSIDE_MODE . .  C ADDR   03F0H   R   SEG=RUNNING
CASR_OUT_CHK_CD . . .  C ADDR   041BH   R   SEG=RUNNING
CASR_OUT_CHK_D. . . .  C ADDR   0420H   R   SEG=RUNNING
CASR_OUT_CHK_F. . . .  C ADDR   040AH   R   SEG=RUNNING
CASR_OUT_CHK_OTHER. .  C ADDR   03FEH   R   SEG=RUNNING
CASR_OUT_SHOW . . . .  C ADDR   0414H   R   SEG=RUNNING
CASR_RET. . . . . . .  C ADDR   0428H   R   SEG=RUNNING
CASR_SHOW_INSIDE. . .  C ADDR   03CBH   R   SEG=RUNNING
CFR_HI. . . . . . . .  C ADDR   04D2H   R   SEG=RUNNING
CFR_HI_CHK_DN . . . .  C ADDR   0534H   R   SEG=RUNNING
CFR_HI_CHK_UP . . . .  C ADDR   052AH   R   SEG=RUNNING
CFR_LO_CHK_DN . . . .  C ADDR   050FH   R   SEG=RUNNING
CFR_LO_CHK_UP . . . .  C ADDR   0505H   R   SEG=RUNNING
CHECK_AND_SET_REQUEST  C ADDR   039EH   R   SEG=RUNNING
CHECK_ELEV_ARR. . . .  C ADDR   0123H   R   SEG=RUNNING
CHECK_ELEV_CLOSE. . .  C ADDR   012AH   R   SEG=RUNNING
CHECK_ELEV_RUN. . . .  C ADDR   0115H   R   SEG=RUNNING
CHECK_ELEV_RUN2 . . .  C ADDR   011CH   R   SEG=RUNNING
CHECK_FLOOR_REQUEST .  C ADDR   04EDH   R   SEG=RUNNING
CHKFR_FOUND . . . . .  C ADDR   053DH   R   SEG=RUNNING
CHKFR_HI. . . . . . .  C ADDR   0516H   R   SEG=RUNNING
CHKFR_NOTFOUND. . . .  C ADDR   053BH   R   SEG=RUNNING
CLEAR_FLOOR_REQUEST .  C ADDR   04B3H   R   SEG=RUNNING
CURRENT_PASS. . . . .  N NUMB   0068H   A   
CUR_FLR . . . . . . .  N NUMB   0056H   A   
DEBUG_ON. . . . . . .  N NUMB   0067H   A   
EA_BLINK_LOGIC. . . .  C ADDR   0240H   R   SEG=RUNNING
EA_CHECK_INIT . . . .  C ADDR   021AH   R   SEG=RUNNING
EA_CHECK_INIT_OK. . .  C ADDR   021BH   R   SEG=RUNNING
EA_CHECK_MOVE . . . .  C ADDR   0278H   R   SEG=RUNNING
EA_CHECK_REQ. . . . .  C ADDR   023BH   R   SEG=RUNNING
EA_INIT . . . . . . .  C ADDR   0271H   R   SEG=RUNNING
EA_OFF. . . . . . . .  C ADDR   024FH   R   SEG=RUNNING
EA_OFFSET_UPDATE. . .  C ADDR   0281H   R   SEG=RUNNING
EA_PLAY_SOUND . . . .  C ADDR   027CH   R   SEG=RUNNING
EA_TAIL . . . . . . .  C ADDR   0255H   R   SEG=RUNNING
ECP_EXEC. . . . . . .  C ADDR   018FH   R   SEG=RUNNING
ECP_GO_8. . . . . . .  C ADDR   018DH   R   SEG=RUNNING
ECP_MOVE. . . . . . .  C ADDR   0197H   R   SEG=RUNNING
ECP_TEST. . . . . . .  C ADDR   0187H   R   SEG=RUNNING
EC_BLINK_LOGIC. . . .  C ADDR   02C9H   R   SEG=RUNNING
EC_CHECK_CUR. . . . .  C ADDR   02AEH   R   SEG=RUNNING
EC_CHECK_INIT . . . .  C ADDR   029BH   R   SEG=RUNNING
EC_CHECK_INIT_OK. . .  C ADDR   029CH   R   SEG=RUNNING
EC_CHECK_REQ. . . . .  C ADDR   02C4H   R   SEG=RUNNING
EC_INIT . . . . . . .  C ADDR   02EBH   R   SEG=RUNNING
EC_OFF. . . . . . . .  C ADDR   02D8H   R   SEG=RUNNING
EC_REOPEN . . . . . .  C ADDR   02B1H   R   SEG=RUNNING
A51 MACRO ASSEMBLER  RUNNINGTASK                                                          01/10/2026 10:26:27 PAGE    25

EC_TAIL . . . . . . .  C ADDR   02DEH   R   SEG=RUNNING
EH_CHECK_CUR_FL . . .  C ADDR   0147H   R   SEG=RUNNING
EH_OPEN_NOW . . . . .  C ADDR   0153H   R   SEG=RUNNING
EH_SCAN . . . . . . .  C ADDR   0166H   R   SEG=RUNNING
ELEV_ARRIVED. . . . .  N NUMB   0022H   A   
ELEV_ARRIVED_HANDLER.  C ADDR   0213H   R   SEG=RUNNING
ELEV_CHECK_PARK . . .  C ADDR   017EH   R   SEG=RUNNING
ELEV_CLOSE. . . . . .  N NUMB   0023H   A   
ELEV_CLOSE_HANDLER. .  C ADDR   0294H   R   SEG=RUNNING
ELEV_DIFF . . . . . .  C ADDR   01A4H   R   SEG=RUNNING
ELEV_DIR. . . . . . .  N NUMB   0064H   A   
ELEV_HANDLER. . . . .  C ADDR   0132H   R   SEG=RUNNING
ELEV_INIT . . . . . .  C ADDR   0199H   R   SEG=RUNNING
ELEV_NO_REQ . . . . .  C ADDR   0174H   R   SEG=RUNNING
ELEV_RUN. . . . . . .  N NUMB   0021H   A   
ELEV_RUN_HANDLER. . .  C ADDR   01E9H   R   SEG=RUNNING
ELEV_ST . . . . . . .  N NUMB   0020H   A   
ELEV_START_MOVE . . .  C ADDR   017CH   R   SEG=RUNNING
ELEV_TARGET . . . . .  N NUMB   0058H   A   
ELEV_TIMER. . . . . .  N NUMB   0057H   A   
ER_CHK_INT_KEY. . . .  C ADDR   020AH   R   SEG=RUNNING
ER_INIT . . . . . . .  C ADDR   020EH   R   SEG=RUNNING
EXT_DN_HI . . . . . .  N NUMB   0063H   A   
EXT_DN_LO . . . . . .  N NUMB   0062H   A   
EXT_UP_HI . . . . . .  N NUMB   005FH   A   
EXT_UP_LO . . . . . .  N NUMB   005EH   A   
E_GO_DOWN . . . . . .  C ADDR   01C4H   R   SEG=RUNNING
E_START . . . . . . .  C ADDR   01CEH   R   SEG=RUNNING
FLOOR_TO_INDEX. . . .  C ADDR   0429H   R   SEG=RUNNING
FTI_NEG . . . . . . .  C ADDR   0430H   R   SEG=RUNNING
GET_BIT_MASK. . . . .  C ADDR   04A4H   R   SEG=RUNNING
GET_FLOOR_FROM_KEY. .  C ADDR   0339H   R   SEG=RUNNING
GFK_INVALID . . . . .  C ADDR   0350H   R   SEG=RUNNING
GFK_KEY_0 . . . . . .  C ADDR   0348H   R   SEG=RUNNING
GFK_KEY_1 . . . . . .  C ADDR   034CH   R   SEG=RUNNING
INDEX_TO_FLOOR. . . .  C ADDR   0434H   R   SEG=RUNNING
INPUT_MODE. . . . . .  N NUMB   0065H   A   
INT_REQ_HI. . . . . .  N NUMB   005DH   A   
INT_REQ_LO. . . . . .  N NUMB   005CH   A   
ITF_CHK1. . . . . . .  C ADDR   043BH   R   SEG=RUNNING
ITF_POS . . . . . . .  C ADDR   0441H   R   SEG=RUNNING
LCD_CLEAR . . . . . .  C ADDR   -----       EXT
LCD_INIT. . . . . . .  C ADDR   -----       EXT
LCD_MSG_CLOSE . . . .  C ADDR   0079H   R   SEG=RUNNING
LCD_MSG_FL. . . . . .  C ADDR   009BH   R   SEG=RUNNING
LCD_MSG_INSIDE. . . .  C ADDR   0031H   R   SEG=RUNNING
LCD_MSG_OPEN. . . . .  C ADDR   0068H   R   SEG=RUNNING
LCD_MSG_RUN . . . . .  C ADDR   008AH   R   SEG=RUNNING
LCD_MSG_WELCOME . . .  C ADDR   0042H   R   SEG=RUNNING
LCD_PRINT_FLOOR . . .  C ADDR   0352H   R   SEG=RUNNING
LCD_SHOW_STR. . . . .  C ADDR   -----       EXT
LCD_STR_DOWN. . . . .  C ADDR   005EH   R   SEG=RUNNING
LCD_STR_EMPTY . . . .  C ADDR   0063H   R   SEG=RUNNING
LCD_STR_OUT_PREFIX. .  C ADDR   0053H   R   SEG=RUNNING
LCD_STR_UP. . . . . .  C ADDR   0059H   R   SEG=RUNNING
LCD_WR_CMD. . . . . .  C ADDR   -----       EXT
LCD_WR_DAT. . . . . .  C ADDR   -----       EXT
LED6_APPLYTABLE . . .  C ADDR   -----       EXT
LPF_NEG . . . . . . .  C ADDR   0362H   R   SEG=RUNNING
NEW_PASS_ST . . . . .  N NUMB   0004H   A   
ONE_SEC_CNT . . . . .  N NUMB   0059H   A   
OPT1_ST . . . . . . .  N NUMB   0011H   A   
OPT2_ST . . . . . . .  N NUMB   0012H   A   
OPT3_ST . . . . . . .  N NUMB   0013H   A   
OPT_ST. . . . . . . .  N NUMB   0001H   A   
OUT_SEL_VAL . . . . .  N NUMB   0066H   A   
A51 MACRO ASSEMBLER  RUNNINGTASK                                                          01/10/2026 10:26:27 PAGE    26

PASSWORD_TABLE. . . .  C ADDR   002CH   R   SEG=RUNNING
PASS_NEXT_ST. . . . .  N NUMB   006DH   A   
PASS_ST . . . . . . .  N NUMB   0002H   A   
RESET_CHOICE_ST . . .  N NUMB   0003H   A   
RT_CONFIG_DONE. . . .  C ADDR   010EH   R   SEG=RUNNING
RT_HANDLE_KEY . . . .  C ADDR   00E5H   R   SEG=RUNNING
RT_HANDLE_OTHER . . .  C ADDR   00F5H   R   SEG=RUNNING
RT_INIT . . . . . . .  C ADDR   00FAH   R   SEG=RUNNING
RT_MODE . . . . . . .  C ADDR   0100H   R   SEG=RUNNING
RT_RETURN . . . . . .  C ADDR   0131H   R   SEG=RUNNING
RUNNING . . . . . . .  C SEG    0712H       REL=UNIT
RUNNINGTASK_HANDLER .  C ADDR   00D4H   R   SEG=RUNNING
RUNNINGTASK_INIT. . .  C ADDR   00A0H   R   SEG=RUNNING
RUN_ST. . . . . . . .  N NUMB   0000H   A   
SCAN_CHECK_DN_LOOSE .  C ADDR   069AH   R   SEG=RUNNING
SCAN_CHECK_DN_REQUEST  C ADDR   0606H   R   SEG=RUNNING
SCAN_CHECK_DN_STRICT.  C ADDR   063AH   R   SEG=RUNNING
SCAN_CHECK_UP_LOOSE .  C ADDR   06C0H   R   SEG=RUNNING
SCAN_CHECK_UP_REQUEST  C ADDR   05D2H   R   SEG=RUNNING
SCAN_CHECK_UP_STRICT.  C ADDR   066AH   R   SEG=RUNNING
SCAN_DEFAULT_UP . . .  C ADDR   0561H   R   SEG=RUNNING
SCAN_DN_LOOP_LOOSE. .  C ADDR   05AFH   R   SEG=RUNNING
SCAN_DN_LOOP_STRICT .  C ADDR   059FH   R   SEG=RUNNING
SCAN_DN_LOOSE_DONE. .  C ADDR   05C1H   R   SEG=RUNNING
SCAN_DN_STRICT_DONE .  C ADDR   05ADH   R   SEG=RUNNING
SCAN_FAIL . . . . . .  C ADDR   05CBH   R   SEG=RUNNING
SCAN_FIND_NEXT_TARGET  C ADDR   053FH   R   SEG=RUNNING
SCAN_FOUND. . . . . .  C ADDR   05D0H   R   SEG=RUNNING
SCAN_HAS_REQ. . . . .  C ADDR   054FH   R   SEG=RUNNING
SCAN_TRY_DOWN . . . .  C ADDR   0599H   R   SEG=RUNNING
SCAN_TRY_UP . . . . .  C ADDR   0564H   R   SEG=RUNNING
SCAN_UP_LOOP_LOOSE. .  C ADDR   057FH   R   SEG=RUNNING
SCAN_UP_LOOP_STRICT .  C ADDR   056AH   R   SEG=RUNNING
SCDL_FOUND. . . . . .  C ADDR   06BCH   R   SEG=RUNNING
SCDL_HI . . . . . . .  C ADDR   06AFH   R   SEG=RUNNING
SCDL_NOTFOUND . . . .  C ADDR   06B8H   R   SEG=RUNNING
SCDR_FOUND. . . . . .  C ADDR   0636H   R   SEG=RUNNING
SCDR_HI . . . . . . .  C ADDR   0620H   R   SEG=RUNNING
SCDR_NOTFOUND . . . .  C ADDR   0632H   R   SEG=RUNNING
SCDS_FOUND. . . . . .  C ADDR   0666H   R   SEG=RUNNING
SCDS_HI . . . . . . .  C ADDR   0654H   R   SEG=RUNNING
SCDS_NOTFOUND . . . .  C ADDR   0662H   R   SEG=RUNNING
SCUL_FOUND. . . . . .  C ADDR   06E2H   R   SEG=RUNNING
SCUL_HI . . . . . . .  C ADDR   06D5H   R   SEG=RUNNING
SCUL_NOTFOUND . . . .  C ADDR   06DEH   R   SEG=RUNNING
SCUR_FOUND. . . . . .  C ADDR   0602H   R   SEG=RUNNING
SCUR_HI . . . . . . .  C ADDR   05ECH   R   SEG=RUNNING
SCUR_NOTFOUND . . . .  C ADDR   05FEH   R   SEG=RUNNING
SCUS_FOUND. . . . . .  C ADDR   0696H   R   SEG=RUNNING
SCUS_HI . . . . . . .  C ADDR   0684H   R   SEG=RUNNING
SCUS_NOTFOUND . . . .  C ADDR   0692H   R   SEG=RUNNING
SEDR_HI . . . . . . .  C ADDR   0496H   R   SEG=RUNNING
SEG_TABLE . . . . . .  C ADDR   0000H   R   SEG=RUNNING
SET_EXT_DN_REQUEST. .  C ADDR   0484H   R   SEG=RUNNING
SET_EXT_UP_REQUEST. .  C ADDR   0464H   R   SEG=RUNNING
SET_INT_REQUEST . . .  C ADDR   0444H   R   SEG=RUNNING
SEUR_HI . . . . . . .  C ADDR   0476H   R   SEG=RUNNING
SHOW_OPEN_FLOOR . . .  C ADDR   02F9H   R   SEG=RUNNING
SHOW_OUTSIDE_STATUS .  C ADDR   0370H   R   SEG=RUNNING
SINGER_PLAYNOTE . . .  C ADDR   -----       EXT
SIR_HI. . . . . . . .  C ADDR   0456H   R   SEG=RUNNING
SOF_NEG . . . . . . .  C ADDR   032FH   R   SEG=RUNNING
SOS_NONE. . . . . . .  C ADDR   0397H   R   SEG=RUNNING
SOS_UP. . . . . . . .  C ADDR   0390H   R   SEG=RUNNING
SUL_DONE. . . . . . .  C ADDR   0591H   R   SEG=RUNNING
SUS_CHECK . . . . . .  C ADDR   0573H   R   SEG=RUNNING
A51 MACRO ASSEMBLER  RUNNINGTASK                                                          01/10/2026 10:26:27 PAGE    27

SUS_NEXT. . . . . . .  C ADDR   0578H   R   SEG=RUNNING
UCD_NEG . . . . . . .  C ADDR   06F2H   R   SEG=RUNNING
UPDATE_CUR_DISPLAY. .  C ADDR   06E6H   R   SEG=RUNNING
UPDATE_TGT_DISPLAY. .  C ADDR   06FCH   R   SEG=RUNNING
UTD_NEG . . . . . . .  C ADDR   0708H   R   SEG=RUNNING


REGISTER BANK(S) USED: 0 


ASSEMBLY COMPLETE.  0 WARNING(S), 0 ERROR(S)
